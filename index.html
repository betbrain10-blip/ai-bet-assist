<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vincit√π ‚Ä¢ IA Portal</title>

  <style>
    :root{
      --bg1:#2a0f55;
      --bg2:#0b244a;

      --panel: rgba(18, 24, 52, .66);
      --panel2: rgba(18, 24, 52, .46);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.46);

      --accent:#ff9800;
      --accent2:#ffb74d;

      --ok:#27d17f;
      --warn:#ffc93a;
      --bad:#ff5a7a;

      --shadow: 0 18px 60px rgba(0,0,0,.42);
      --r1: 18px;
      --r2: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,152,0,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(120,80,255,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{ max-width:1220px; margin:34px auto; padding:0 16px; }

    .shell{
      background: linear-gradient(180deg, rgba(18,24,52,.72), rgba(18,24,52,.58));
      border:1px solid var(--stroke);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }

    .shell:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(800px 240px at 30% 0%, rgba(255,152,0,.18), transparent 60%),
        radial-gradient(680px 240px at 70% 0%, rgba(120,80,255,.14), transparent 55%);
      pointer-events:none;
    }

    .topbar{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 10px 14px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:260px;
    }

    /* LOGO rosso come prima */
    .logo{
      width:34px; height:34px;
      border-radius:10px;
      background:#d8292f;
      display:grid; place-items:center;
      box-shadow: 0 10px 30px rgba(216,41,47,.22);
      border:1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .logo span{ font-weight:1000; font-size:16px; color:#fff; transform:translateY(-.5px); }

    .brand h1{ margin:0; font-size:16px; font-weight:900; letter-spacing:.2px; }
    .brand small{ display:block; margin-top:2px; color:var(--muted); font-size:12px; }

    .status{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{ width:8px;height:8px;border-radius:999px; background:var(--ok); box-shadow:0 0 0 3px rgba(39,209,127,.12); }
    .pill strong{ color:var(--text); font-weight:900; }
    .pill .mini{ color:var(--muted2); font-weight:800; }

    .row{
      position:relative;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
      padding:0 10px 10px;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:var(--r1);
      padding:14px;
    }

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    .panelHeader .title{
      display:flex; align-items:center; gap:8px;
      font-weight:1000; font-size:13px; color:var(--text);
    }

    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      border-color: rgba(255,152,0,.35);
      background: linear-gradient(180deg, rgba(255,152,0,.95), rgba(255,152,0,.72));
      color:#1c1208;
      box-shadow: 0 18px 40px rgba(255,152,0,.12);
    }
    .btn.primary:hover{
      background: linear-gradient(180deg, rgba(255,169,40,.98), rgba(255,152,0,.78));
    }
    .btn.small{ padding:7px 10px; border-radius:10px; font-weight:1000; }

    .subline{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap; margin:8px 0 10px;
      color:var(--muted); font-size:12px;
    }
    .tag{
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      font-weight:900; color:var(--muted);
    }

    /* ANGOLI SPECIALI pi√π puliti */
    .callout{
      margin-top:10px;
      background: rgba(255,255,255,.045);
      border:1px solid rgba(255,255,255,.09);
      border-radius:14px;
      padding:12px;
    }
    .calloutHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px;
    }
    .calloutHead .left{
      display:flex; align-items:center; gap:8px;
      font-weight:1000; font-size:12.5px;
    }
    .calloutHead .right{
      display:flex; align-items:center; gap:8px;
      color:var(--muted); font-size:12px; font-weight:900;
    }

    .calloutGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr; }
      .calloutGrid{ grid-template-columns: 1fr; }
      .status{ justify-content:flex-start; }
    }

    .miniCard{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10, 14, 38, .34);
      padding:10px;
    }

    .miniTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:1000; font-size:12px;
      margin-bottom:8px;
    }
    .miniTop .meta{ color:var(--muted); font-weight:900; font-size:11.5px; white-space:nowrap; }

    .miniItem{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      margin-top:10px;
    }
    .miniItem:first-child{ margin-top:0; }

    .badges{ display:flex; gap:6px; flex-wrap:wrap; margin:8px 0 6px; }
    .badge{
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:11px;
      font-weight:1000;
      color:var(--muted);
    }
    .badge.ok{ background: rgba(39,209,127,.14); border-color: rgba(39,209,127,.22); color: rgba(230,255,242,.92); }
    .badge.warn{ background: rgba(255,201,58,.14); border-color: rgba(255,201,58,.24); color: rgba(255,245,210,.95); }
    .badge.bad{ background: rgba(255,90,122,.14); border-color: rgba(255,90,122,.22); color: rgba(255,230,236,.95); }

    .miniText{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .miniCTA{
      margin-top:10px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .miniCTA .btnMini{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
      width:100%;
    }
    .miniCTA .btnMini:hover{ background: rgba(255,255,255,.09); }

    /* EVENTI */
    .eventCard{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.035);
      overflow:hidden;
    }
    .eventHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px;
      background: rgba(0,0,0,.12);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .eventLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .leagueDot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(0,255,180,.7);
      box-shadow:0 0 0 3px rgba(0,255,180,.12);
      flex:0 0 auto;
    }
    .eventTitle{ min-width:0; }
    .eventTitle .meta{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:11.5px;
      font-weight:900;
      margin-bottom:3px;
    }
    .chip{
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      font-weight:1000;
      font-size:11px;
      white-space:nowrap;
    }
    .matchLine{
      display:flex; align-items:center; gap:10px;
      font-weight:1000; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .team{ display:flex; align-items:center; gap:8px; min-width:0; }

    .crest{
      width:18px; height:18px; border-radius:6px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .crest img{ width:100%; height:100%; object-fit:contain; display:block; }
    .crest .ini{ font-size:10px; font-weight:1000; color:rgba(255,255,255,.82); }

    .eventRight{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .eventBody{ padding:12px; }

    /* Motivazioni pi√π chiare: 3 righe massimo */
    .reasonBox{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,38,.24);
      padding:10px;
      margin-bottom:10px;
    }
    .reasonBox .r1{ font-weight:1000; font-size:12.5px; margin-bottom:6px; }
    .reasonBox .r2{ color:var(--muted); font-size:12px; line-height:1.35; }
    .reasonBox .r3{ margin-top:8px; color:rgba(255,255,255,.78); font-size:12px; font-weight:900; }

    .markets{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .markets{ grid-template-columns: 1fr; } }

    .mkt{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10, 14, 38, .32);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:110px;
    }
    .mktTop{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .mktName{ font-weight:1000; font-size:12.5px; display:flex; align-items:center; gap:8px; }

    .prio{
      padding:5px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      font-size:11px;
      font-weight:1000;
      color:var(--muted);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .prio.ok{ background: rgba(39,209,127,.14); border-color: rgba(39,209,127,.22); color: rgba(230,255,242,.92); }
    .prio.warn{ background: rgba(255,201,58,.14); border-color: rgba(255,201,58,.24); color: rgba(255,245,210,.95); }
    .prio.bad{ background: rgba(255,90,122,.14); border-color: rgba(255,90,122,.22); color: rgba(255,230,236,.95); }

    .mktText{ color:var(--muted); font-size:12px; line-height:1.35; min-height:40px; }
    .mktActions{ display:flex; gap:8px; align-items:center; margin-top:auto; }

    .btn2{
      flex:1;
      border-radius:12px;
      padding:9px 10px;
      font-size:12px;
      font-weight:1000;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      transition: transform .08s ease, background .15s ease;
    }
    .btn2:hover{ background: rgba(255,255,255,.09); }
    .btn2:active{ transform: translateY(1px); }
    .btn2.add{
      border-color: rgba(255,152,0,.35);
      background: linear-gradient(180deg, rgba(255,152,0,.92), rgba(255,152,0,.70));
      color:#1c1208;
    }
    .btn2.add:hover{
      background: linear-gradient(180deg, rgba(255,169,40,.96), rgba(255,152,0,.76));
    }

    /* RIGHT */
    .rightPanel h3{
      margin:0 0 10px;
      font-size:13px;
      font-weight:1000;
      display:flex; align-items:center; gap:8px;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .field{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10, 14, 38, .28);
      padding:10px;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      margin-bottom:7px;
    }
    .field input, .field select{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      outline:none;
      font-weight:1000;
    }

    .sumRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin:10px 0 12px;
    }
    .sumBox{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:10px;
    }
    .sumBox .k{ color:var(--muted); font-size:11px; font-weight:900; }
    .sumBox .v{ margin-top:6px; font-size:14px; font-weight:1000; }

    .ticket{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10, 14, 38, .26);
      padding:12px;
      margin-top:10px;
    }
    .ticketHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      margin-bottom:8px;
    }
    .ticketList{ display:flex; flex-direction:column; gap:8px; margin:8px 0 10px; }
    .pick{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pick .left{ min-width:0; }
    .pick .left strong{
      display:block;
      font-weight:1000;
      font-size:12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pick .left span{
      display:block;
      color:var(--muted);
      font-size:11.5px;
      font-weight:900;
      margin-top:2px;
    }
    .pick .rm{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
    }

    .bigPrint{
      width:100%;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(255,152,0,.35);
      background: linear-gradient(180deg, rgba(255,152,0,.95), rgba(255,152,0,.70));
      color:#1c1208;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(255,152,0,.12);
    }
    .bigPrint:active{ transform: translateY(1px); }

    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10, 14, 38, .92);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      font-weight:900;
      font-size:12.5px;
      display:none;
      z-index:9999;
      max-width: 92vw;
    }

    /* MODALS */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9998;
      padding:16px;
    }
    .modal{
      width:min(920px, 96vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10, 14, 38, .92);
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead strong{ font-size:13px; font-weight:1000; }
    .modalHead button{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
    }
    .modalBody{ padding:14px; }

    .wheelGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){ .wheelGrid{ grid-template-columns: 1fr; } }
    .wheelBox{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    canvas{ width:100%; height:auto; display:block; }

    .wheelBtn{
      width:100%;
      margin-top:10px;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(255,152,0,.35);
      background: linear-gradient(180deg, rgba(255,152,0,.95), rgba(255,152,0,.72));
      color:#1c1208;
      font-weight:1000;

      cursor:pointer;
    }
    .wheelNote{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .quizBox{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    .qTitle{ font-weight:1000; margin:0 0 10px; font-size:13px; }
    .qOpt{
      width:100%;
      text-align:left;
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
    }
    .qOpt:hover{ background: rgba(255,255,255,.08); }
    .qMsg{ margin-top:10px; color:var(--muted); font-size:12px; font-weight:900; }

    @media print{
      body{ background:white; color:#111; }
      .wrap{ margin:0; padding:0; }
      .shell{ box-shadow:none; border:none; background:white; }
      .panel, .rightPanel{ border:1px solid #ddd; background:white; }
      .btn, .btn2, .bigPrint, .pill { display:none !important; }
      .modalBack, .toast { display:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="logo" title="Vincit√π"><span>V</span></div>
          <div>
            <h1>Vincit√π ‚Ä¢ IA Portal</h1>
            <small>Eventi reali ‚Ä¢ quote non mostrate: si inseriscono al banco</small>
          </div>
        </div>

        <div class="status">
          <div class="pill"><span class="dot"></span> Centro: <strong id="centerId">VINC001</strong></div>
          <div class="pill">Agg: <strong id="updatedAt">‚Äî</strong></div>
          <div class="pill">Fascia: <strong id="slotLabel">‚Äî</strong></div>
          <button class="btn small" id="openWheel">üé° Ruota</button>
          <button class="btn small" id="openQuiz">‚ùì Quiz</button>
        </div>
      </div>

      <div class="row">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHeader">
            <div class="title">‚ö° Eventi (IA)</div>
            <div class="btnRow">
              <button class="btn primary" id="btnReload">Nuovi eventi</button>
              <button class="btn" id="btnSlot">Cambia fascia</button>
              <button class="btn" id="btnFocus">Start 20s</button>
              <span class="chip" id="eventsCount">Eventi mostrati: ‚Äî</span>
            </div>
          </div>

          <div class="subline">
            <span class="tag">Quote: <strong style="color:var(--text)">verifica al banco</strong></span>
            <span class="tag">Modalit√† cliente: <strong style="color:var(--text)">chiaro & veloce</strong></span>
            <span class="tag" id="missionTag">Missione: <strong style="color:var(--text)">Max 2 selezioni</strong></span>
          </div>

          <!-- Corner & Cards puliti (NO duplicati) -->
          <div class="callout" id="cornerArea">
            <div class="calloutHead">
              <div class="left">üìå Angolo Speciale ‚Ä¢ Corner & Cartellini (rapido)</div>
              <div class="right"><span class="chip" id="cornerHint">Max 2 + 2 (pulito)</span></div>
            </div>

            <div class="calloutGrid">
              <div class="miniCard">
                <div class="miniTop">
                  <span>üö© Corner ‚Äúinteressanti‚Äù (max 2)</span>
                  <span class="meta">solo indicazioni</span>
                </div>
                <div id="cornerList"></div>
              </div>

              <div class="miniCard">
                <div class="miniTop">
                  <span>üü® Cartellini ‚Äúattenzione‚Äù (max 2)</span>
                  <span class="meta">solo indicazioni</span>
                </div>
                <div id="cardsList"></div>
              </div>
            </div>

            <div class="wheelNote" style="margin-top:10px">
              Nota: sono stime ‚Äúritmo / pressione / agonismo‚Äù (senza quote). La quota reale va sempre verificata al banco.
            </div>
          </div>

          <div id="eventsArea"></div>

          <div class="hint">
            Supporto informativo / intrattenimento. Nessuna garanzia. Gioca responsabilmente.
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel rightPanel">
          <h3>üßæ Schedina</h3>

          <div class="formGrid">
            <div class="field">
              <label>Stake (‚Ç¨)</label>
              <input id="stake" type="number" min="1" step="1" value="5" />
            </div>

            <div class="field">
              <label>Tipo</label>
              <select id="type">
                <option value="multipla">Multipla (tutte)</option>
                <option value="singole">Singole (una alla volta)</option>
              </select>
            </div>
          </div>

          <div class="sumRow">
            <div class="sumBox">
              <div class="k">Selezioni</div>
              <div class="v" id="selCount">0</div>
            </div>
            <div class="sumBox">
              <div class="k">Quota totale</div>
              <div class="v" id="quotaTot">‚Äî</div>
            </div>
            <div class="sumBox">
              <div class="k">Vincita pot.</div>
              <div class="v" id="winPot">‚Äî</div>
            </div>
          </div>

          <div class="ticket">
            <div class="ticketHead">
              <span>‚úÖ Selezioni</span>
              <span class="chip">Qui inserisci la quota reale al banco quando serve</span>
            </div>

            <div class="ticketList" id="ticketList">
              <div class="hint" style="margin:0">Nessuna selezione. Aggiungi una giocata a sinistra.</div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>Quota reale totale (facoltativo)</label>
              <input id="realQuota" type="number" min="1" step="0.01" placeholder="es. 3.25" />
            </div>

            <button class="bigPrint" id="printBtn">üñ®Ô∏è Stampa schedina</button>

            <div class="hint">
              Suggerimento: 2‚Äì3 selezioni massimo per mantenere controllo.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- WHEEL MODAL -->
  <div class="modalBack" id="wheelBack">
    <div class="modal">
      <div class="modalHead">
        <strong>üé° Ruota della Fortuna (consigli & missioni)</strong>
        <button id="closeWheel">Chiudi ‚úï</button>
      </div>
      <div class="modalBody">
        <div class="wheelGrid">
          <div class="wheelBox">
            <canvas id="wheel" width="520" height="520"></canvas>
            <button class="wheelBtn" id="spinBtn">Gira la ruota</button>
            <div class="wheelNote" id="wheelLimit">
              1 giro al giorno per questo PC. Solo intrattenimento, gioco responsabile.
            </div>
          </div>
          <div class="wheelBox">
            <div class="miniTop" style="margin-bottom:10px;">
              <span>üéÅ Risultato</span>
              <span class="meta" id="wheelWhen">‚Äî</span>
            </div>
            <div class="miniText" id="wheelResultText" style="font-size:13px; color:rgba(255,255,255,.88); font-weight:900">
              Gira la ruota: ti d√† un consiglio ‚Äúda banco‚Äù semplice e utile.
            </div>

            <div class="badges" style="margin-top:12px">
              <span class="badge ok" id="wheelMission">Missione: Max 2 selezioni</span>
              <span class="badge warn" id="wheelRule">Regola: stop se perdi</span>
              <span class="badge" id="wheelFun">Bonus: quiz 1 domanda</span>
            </div>

            <div class="wheelNote" style="margin-top:12px">
              Tip serio: se la quota al banco √® diversa, <strong>riduci selezioni</strong> o fai singola.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ MODAL -->
  <div class="modalBack" id="quizBack">
    <div class="modal">
      <div class="modalHead">
        <strong>‚ùì Quiz veloce (30s)</strong>
        <button id="closeQuiz">Chiudi ‚úï</button>
      </div>
      <div class="modalBody">
        <div class="quizBox">
          <p class="qTitle" id="qTitle">‚Äî</p>
          <div id="qOptions"></div>
          <div class="qMsg" id="qMsg">Rispondi: √® solo intrattenimento üòä</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // STATE
    // =========================
    const SLOT_ORDER = ["mattina","pomeriggio","sera"];
    let CURRENT_SLOT = "sera";
    let EVENTS_DATA = null;

    const ticket = [];
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display="none", 2200);
    }

    function nowRome(){
      return new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Rome" }));
    }

    function slotFromTime(d){
      const h = d.getHours();
      if (h >= 6 && h < 12) return "mattina";
      if (h >= 12 && h < 18) return "pomeriggio";
      return "sera";
    }

    function slotLabel(s){
      return s === "mattina" ? "Mattina" : s === "pomeriggio" ? "Pomeriggio" : "Sera";
    }

    function formatClock(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${dd} ${hh}:${mm}`;
    }

    // Stable hash
    function hash32(str){
      let h = 2166136261;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }

    function todayKey(){
      const d = nowRome();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    // =========================
    // "NUOVI EVENTI" veri: rotazione
    // =========================
    function slotOffsetKey(slot){ return `slot_offset_${slot}_${todayKey()}`; }
    function getSlotOffset(slot){ return parseInt(localStorage.getItem(slotOffsetKey(slot)) || "0", 10) || 0; }
    function bumpSlotOffset(slot){
      const n = getSlotOffset(slot) + 1;
      localStorage.setItem(slotOffsetKey(slot), String(n));
      return n;
    }

    function uniqueBy(list, keyFn){
      const seen = new Set();
      const out = [];
      for (const x of list){
        const k = keyFn(x);
        if (seen.has(k)) continue;
        seen.add(k);
        out.push(x);
      }
      return out;
    }

    // prende 5 eventi dalla fascia, ma ruota l'elenco in modo deterministico
    function pick5ForSlot(allEvents, slot){
      const poolRaw = allEvents.filter(e => (e.slot || "").toLowerCase() === slot);
      const pool = uniqueBy(poolRaw.length ? poolRaw : allEvents, e => e.uniq || `${e.home}|${e.away}|${e.start_iso||e.start||""}`);

      const k = 5;
      if (pool.length <= k) return pool.slice(0,k);

      const offset = getSlotOffset(slot);
      const seed = hash32(`${todayKey()}|${slot}|${offset}|VINC001`);

      // "shuffle" stabile: ordina per hash
      const sorted = [...pool].sort((a,b)=>{
        const ha = hash32((a.uniq||"")+seed);
        const hb = hash32((b.uniq||"")+seed);
        return ha - hb;
      });

      return sorted.slice(0,k);
    }

    // =========================
    // FETCH
    // =========================
    async function fetchEvents(force=false){
      const url = force ? `events.json?v=${Date.now()}` : "events.json";
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error("Impossibile caricare events.json");
      return await r.json();
    }

    // =========================
    // STEMMI (se non arrivano da events.json)
    // =========================
    function crestHTML(url, name){
      if (url){
        return `<span class="crest"><img src="${url}" alt="" referrerpolicy="no-referrer"
          onerror="this.parentElement.innerHTML='<span class=\\'ini\\'>${(name||'?').slice(0,2).toUpperCase()}</span>';"></span>`;
      }
      return `<span class="crest"><span class="ini">${(name||'?').slice(0,2).toUpperCase()}</span></span>`;
    }

    function safeTxt(s){ return (s || "").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // =========================
    // MOTIVAZIONI pi√π credibili e chiare
    // =========================
    function favoriteSide(ev){
      const key = `${ev.league_code||""}|${ev.home||""}|${ev.away||""}|${ev.start_iso||ev.start||""}`;
      const x = hash32(key) % 1000;
      const fav = (x < 520) ? "home" : "away";
      const gap = Math.abs(500 - x); // 0..500
      return { fav, gap };
    }

    function riskFromGap(gap){
      if (gap > 260) return "Bassa";
      if (gap > 140) return "Media";
      return "Alta";
    }
    function prioClass(r){
      if (r === "Bassa") return "ok";
      if (r === "Media") return "warn";
      return "bad";
    }
    function prioLabel(r){
      if (r === "Bassa") return "Pi√π stabile";
      if (r === "Media") return "Equilibrata";
      return "Rischiosa";
    }

    function scenarioLine(ev){
      const { fav, gap } = favoriteSide(ev);
      const r = riskFromGap(gap);

      if (r === "Bassa"){
        return fav === "home"
          ? "Scenario: favorita in casa ‚Üí ritmo spesso alto e pressione continua."
          : "Scenario: favorita ospite ‚Üí pu√≤ comandare, ma attenzione all‚Äôeffetto trasferta.";
      }
      if (r === "Media") return "Scenario: equilibrio medio ‚Üí partita aperta ma con fasi di controllo.";
      return "Scenario: match molto equilibrato ‚Üí pu√≤ cambiare con un episodio (prudenza).";
    }

    function bankTip(ev){
      const { gap } = favoriteSide(ev);
      if (gap > 260) return "Tip banco: se quota scende troppo, evita la multipla lunga.";
      if (gap > 140) return "Tip banco: meglio 1‚Äì2 selezioni, quota reale fa la differenza.";
      return "Tip banco: se quota non convince, passa o gioca singola leggera.";
    }

    function overReason(ev){
      const { gap } = favoriteSide(ev);
      if (gap > 260) return "Over 2.5: pu√≤ arrivare per pressione costante (controlla lineup).";
      if (gap > 140) return "Over 2.5: buono se ritmo non √® troppo tattico (verifica quota).";
      return "Over 2.5: pi√π variabile in match equilibrato ‚Üí stake basso.";
    }

    function oneXReason(ev){
      const { fav, gap } = favoriteSide(ev);
      if (gap > 260){
        if (fav === "home") return "1X: copertura sensata se la casa √® favorita (quota decide).";
        return "1X: attenzione: se l‚Äôospite √® molto favorito, non √® ‚Äútranquillo‚Äù.";
      }
      if (gap > 140) return "1X: ok come copertura solo con quota reale conveniente.";
      return "1X: match equilibrato ‚Üí non √® sicuro, valuta alternative o singola.";
    }

    function ggReason(ev){
      const { gap } = favoriteSide(ev);
      if (gap > 260) return "Goal S√¨: utile solo se anche lo sfavorito crea (occhio assenze).";
      if (gap > 140) return "Goal S√¨: interessante se entrambe attaccano (quota al banco).";
      return "Goal S√¨: spesso ci sta, ma varia tanto ‚Üí non forzare multipla.";
    }

    function prioForMarket(ev, kind){
      const { fav, gap } = favoriteSide(ev);
      let r = riskFromGap(gap);
      if (kind === "1x" && fav === "away" && gap > 260) r = "Alta";
      if (kind === "gg" && gap > 260) r = "Media";
      return r;
    }

    // =========================
    // CORNER & CARTELLINI "puliti" (NO duplicati)
    // =========================
    function cornerCardSignals(ev, type){
      const k = `${type}|${ev.league_code||""}|${ev.home||""}|${ev.away||""}|${ev.start_iso||ev.start||""}`;
      const x = hash32(k) % 100;
      const pressure = (x > 70) ? "Alta" : (x > 40) ? "Media" : "Media";
      const balance = (x > 65) ? "Equilibrio" : (x > 35) ? "Leggera favorita" : "Favorita netta";
      const physical = (x > 60) ? "Alto" : "Medio";

      const reasonCorner =
        (balance === "Favorita netta")
          ? "Corner: probabili se la favorita spinge a lungo (pressione costante)."
          : (balance === "Equilibrio")
            ? "Corner: possibili su ribaltamenti e fasce, valuta quota reale."
            : "Corner: discreti, ma non forzare multipla lunga.";

      const reasonCards =
        (physical === "Alto")
          ? "Cartellini: gara fisica ‚Üí contatti/proteste possibili (quota al banco)."
          : "Cartellini: possibili, ma dipende molto dall‚Äôarbitro (prudenza).";

      return { pressure, balance, physical, reason: type==="corner"?reasonCorner:reasonCards };
    }

    function renderMiniPick(ev, type){
      const sig = cornerCardSignals(ev, type);
      const lvl = (type==="corner") ? sig.pressure : sig.physical;
      const lvlClass = (lvl==="Alta" || lvl==="Alto") ? "ok" : "warn";

      return `
        <div class="miniItem">
          <div class="miniTop">
            <span>${safeTxt(ev.home)} - ${safeTxt(ev.away)}</span>
            <span class="meta">${safeTxt(ev.start || "")}</span>
          </div>
          <div class="badges">
            <span class="badge ${lvlClass}">${type==="corner" ? "Pressione" : "Agonismo"}: ${lvl}</span>
            <span class="badge">${sig.balance}</span>
            <span class="badge ok">Verifica al banco</span>
          </div>
          <div class="miniText">${safeTxt(sig.reason)}</div>
          <div class="miniCTA">
            <button class="btnMini" onclick="verifyBank()">Verifica al banco</button>
          </div>
        </div>
      `;
    }

    function renderCornerArea(allEvents){
      const list = uniqueBy(allEvents, e => e.uniq || `${e.home}|${e.away}|${e.start||""}`);
      if (!list.length){
        $("cornerList").innerHTML = `<div class="hint" style="margin:0">Nessun dato.</div>`;
        $("cardsList").innerHTML = `<div class="hint" style="margin:0">Nessun dato.</div>`;
        return;
      }

      // scegli 2 + 2 ma garantendo match diversi
      const seed = hash32(`${todayKey()}|${CURRENT_SLOT}|corner`);
      const sorted = [...list].sort((a,b)=> (hash32((a.uniq||"")+seed) - hash32((b.uniq||"")+seed)));

      const corners = sorted.slice(0,2);
      const used = new Set(corners.map(x => x.uniq || `${x.home}|${x.away}|${x.start||""}`));
      const cards = sorted.filter(x => !used.has(x.uniq || `${x.home}|${x.away}|${x.start||""}`)).slice(0,2);

      $("cornerList").innerHTML = corners.map(ev=>renderMiniPick(ev,"corner")).join("");
      $("cardsList").innerHTML = cards.map(ev=>renderMiniPick(ev,"cards")).join("");
    }

    // =========================
    // EVENTS RENDER
    // =========================
    function renderEvents(picked){
      const area = $("eventsArea");
      if (!picked.length){
        area.innerHTML = `<div class="hint">Nessun evento in questa fascia. Prova a cambiare fascia.</div>`;
        $("eventsCount").textContent = "Eventi mostrati: 0/5";
        return;
      }
      $("eventsCount").textContent = `Eventi mostrati: ${picked.length}/5`;

      area.innerHTML = picked.map((ev, idx)=>{
        const league = safeTxt(ev.league || ev.league_code || "Calcio");
        const when = safeTxt(ev.start || "");
        const homeC = crestHTML(ev.home_crest, ev.home);
        const awayC = crestHTML(ev.away_crest, ev.away);

        const markets = [
          { label:"Over 2.5", kind:"over", txt: overReason(ev), pr: prioForMarket(ev,"over") },
          { label:"1X", kind:"1x", txt: oneXReason(ev), pr: prioForMarket(ev,"1x") },
          { label:"Goal/NoGoal S√¨", kind:"gg", txt: ggReason(ev), pr: prioForMarket(ev,"gg") }
        ];

        return `
          <div class="eventCard">
            <div class="eventHead">
              <div class="eventLeft">
                <div class="leagueDot"></div>
                <div class="eventTitle">
                  <div class="meta">
                    <span class="chip">${league}</span>
                    <span class="chip">${when}</span>
                    <span class="chip">${slotLabel(CURRENT_SLOT)}</span>
                  </div>
                  <div class="matchLine">
                    <span class="team">${homeC}<span>${safeTxt(ev.home)}</span></span>
                    <span style="color:var(--muted);font-weight:1000">-</span>
                    <span class="team">${awayC}<span>${safeTxt(ev.away)}</span></span>
                  </div>
                </div>
              </div>
              <div class="eventRight">
                <span class="chip">Evento ${idx+1}/5</span>
              </div>
            </div>

            <div class="eventBody">
              <div class="reasonBox">
                <div class="r1">üéØ ${safeTxt(scenarioLine(ev))}</div>
                <div class="r2">üìå ${safeTxt(bankTip(ev))}</div>
                <div class="r3">üí¨ ‚ÄúPoche scelte, pi√π controllo.‚Äù</div>
              </div>

              <div class="markets">
                ${markets.map(m=>{
                  const cls = prioClass(m.pr);
                  return `
                    <div class="mkt">
                      <div class="mktTop">
                        <div class="mktName">${safeTxt(m.label)}</div>
                        <span class="prio ${cls}">${prioLabel(m.pr)}</span>
                      </div>
                      <div class="mktText">${safeTxt(m.txt)}</div>
                      <div class="mktActions">
                        <button class="btn2" onclick="verifyBank()">Verifica al banco</button>
                        <button class="btn2 add" onclick="addPick('${encodeURIComponent(ev.uniq||"")}', '${encodeURIComponent(ev.home||"")}', '${encodeURIComponent(ev.away||"")}', '${encodeURIComponent(m.label)}')">+ Aggiungi</button>
                      </div>
                    </div>
                  `;
                }).join("")}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    // =========================
    // TICKET
    // =========================
    window.verifyBank = function(){
      toast("‚úÖ Verifica quota al banco prima di inserire.");
    }

    window.addPick = function(uniq, home, away, market){
      const u = decodeURIComponent(uniq||"");
      const h = decodeURIComponent(home||"");
      const a = decodeURIComponent(away||"");
      const m = decodeURIComponent(market||"");

      if (ticket.length >= 3){
        toast("‚ö†Ô∏è Consiglio: max 2‚Äì3 selezioni per controllo.");
      }

      ticket.push({ uniq:u, match:`${h} - ${a}`, market:m });
      renderTicket();
      toast("Aggiunta selezione ‚úÖ");
    }

    function removePick(i){
      ticket.splice(i,1);
      renderTicket();
    }

    function renderTicket(){
      $("selCount").textContent = String(ticket.length);

      const list = $("ticketList");
      if (!ticket.length){
        list.innerHTML = `<div class="hint" style="margin:0">Nessuna selezione. Aggiungi una giocata a sinistra.</div>`;
      } else {
        list.innerHTML = ticket.map((p, i)=>`
          <div class="pick">
            <div class="left">
              <strong>${safeTxt(p.match)}</strong>
              <span>${safeTxt(p.market)} ‚Ä¢ quota: verifica al banco</span>
            </div>
            <button class="rm" onclick="(${removePick.toString()})(${i})">Rimuovi</button>
          </div>
        `).join("");
      }

      const rq = parseFloat($("realQuota").value);
      const stake = parseFloat($("stake").value) || 0;

      if (rq && rq >= 1.01){
        $("quotaTot").textContent = rq.toFixed(2);
        $("winPot").textContent = (stake * rq).toFixed(2);
      } else {
        $("quotaTot").textContent = "‚Äî";
        $("winPot").textContent = "‚Äî";
      }

      $("missionTag").innerHTML = `Missione: <strong style="color:var(--text)">${ticket.length > 1 ? "Max 3 selezioni" : "Max 2 selezioni"}</strong>`;
    }

    $("printBtn").addEventListener("click", ()=>{
      if (!ticket.length){ toast("Aggiungi almeno 1 selezione."); return; }
      window.print();
    });

    $("realQuota").addEventListener("input", renderTicket);
    $("stake").addEventListener("input", renderTicket);

    // =========================
    // FOCUS 20s
    // =========================
    let focusTm = null;
    $("btnFocus").addEventListener("click", ()=>{
      if (focusTm) return;
      let left = 20;
      const btn = $("btnFocus");
      const old = btn.textContent;
      btn.textContent = `Focus: ${left}s`;
      btn.disabled = true;
      toast("‚è±Ô∏è 20 secondi: scegli con calma.");
      focusTm = setInterval(()=>{
        left--;
        btn.textContent = `Focus: ${left}s`;
        if (left <= 0){
          clearInterval(focusTm);
          focusTm = null;
          btn.textContent = old;
          btn.disabled = false;
          toast("‚úÖ Fine focus: ora scegli (max 2‚Äì3).");
        }
      }, 1000);
    });

    // =========================
    // SLOT + LOAD
    // =========================
    function getSlotFromURL(){
      const u = new URL(location.href);
      const s = (u.searchParams.get("slot") || "").toLowerCase();
      return SLOT_ORDER.includes(s) ? s : "";
    }
    function setSlotInURL(slot){
      const u = new URL(location.href);
      u.searchParams.set("slot", slot);
      history.replaceState({}, "", u.toString());
    }

    async function loadAll(force=false){
      try{
        const data = await fetchEvents(force);
        EVENTS_DATA = data;

        const now = nowRome();
        const urlSlot = getSlotFromURL();
        CURRENT_SLOT = urlSlot || localStorage.getItem("slot") || slotFromTime(now);

        $("updatedAt").textContent = data.updated_at || "‚Äî";
        $("slotLabel").textContent = slotLabel(CURRENT_SLOT);
        $("centerId").textContent = "VINC001";

        const all = (data.events || []).map(e=>{
          if (!e.uniq) e.uniq = `${e.home||""}|${e.away||""}|${e.start_iso||e.start||""}`;
          return e;
        });

        // Corner & Cartellini: usa TUTTO il pool della fascia (non solo i 5 mostrati), cos√¨ √® pi√π vario
        const slotPool = all.filter(e => (e.slot || "").toLowerCase() === CURRENT_SLOT);
        renderCornerArea(slotPool.length ? slotPool : all);

        // Eventi mostrati: 5 ruotabili
        const picked = pick5ForSlot(all, CURRENT_SLOT);
        renderEvents(picked);

      }catch(e){
        console.error(e);
        $("eventsArea").innerHTML = `<div class="hint">Errore: events.json non disponibile o vuoto. Controlla GitHub Actions.</div>`;
        $("updatedAt").textContent = "‚Äî";
        $("slotLabel").textContent = "‚Äî";
      }
    }

    $("btnSlot").addEventListener("click", ()=>{
      const idx = SLOT_ORDER.indexOf(CURRENT_SLOT);
      const next = SLOT_ORDER[(idx+1) % SLOT_ORDER.length];
      CURRENT_SLOT = next;
      $("slotLabel").textContent = slotLabel(CURRENT_SLOT);
      localStorage.setItem("slot", CURRENT_SLOT);
      setSlotInURL(CURRENT_SLOT);
      // reset offset per fascia? NO: lasciamo la rotazione (pi√π ‚Äúnuovi‚Äù)
      if (EVENTS_DATA && EVENTS_DATA.events){
        const all = EVENTS_DATA.events.map(e=>{
          if (!e.uniq) e.uniq = `${e.home||""}|${e.away||""}|${e.start_iso||e.start||""}`;
          return e;
        });
        const slotPool = all.filter(e => (e.slot || "").toLowerCase() === CURRENT_SLOT);
        renderCornerArea(slotPool.length ? slotPool : all);
        renderEvents(pick5ForSlot(all, CURRENT_SLOT));
      }
      toast(`Fascia: ${slotLabel(CURRENT_SLOT)}`);
    });

    // "Nuovi eventi" adesso cambia davvero 5 eventi (offset)
    $("btnReload").addEventListener("click", async ()=>{
      bumpSlotOffset(CURRENT_SLOT);
      if (EVENTS_DATA && EVENTS_DATA.events){
        const all = EVENTS_DATA.events.map(e=>{
          if (!e.uniq) e.uniq = `${e.home||""}|${e.away||""}|${e.start_iso||e.start||""}`;
          return e;
        });
        const slotPool = all.filter(e => (e.slot || "").toLowerCase() === CURRENT_SLOT);
        renderCornerArea(slotPool.length ? slotPool : all);
        renderEvents(pick5ForSlot(all, CURRENT_SLOT));
        toast("‚úÖ Nuovi eventi caricati");
        return;
      }
      // fallback: refetch
      toast("Aggiorno eventi‚Ä¶");
      await loadAll(true);
      toast("‚úÖ Eventi aggiornati");
    });

    // =========================
    // WHEEL
    // =========================
    const wheelItems = [
      "Missione: 2 selezioni max",
      "Regola: stop dopo 1 perdita",
      "Gioca singola (quota buona)",
      "1 match + 1 copertura (non 3 match)",
      "Solo 1 mercato per match",
      "Controlla lineup (ultima ora)",
      "Riduci stake del 20%",
      "Fai 1 quiz e stop"
    ];

    const wheelBack = $("wheelBack");
    $("openWheel").addEventListener("click", ()=> openWheel());
    $("closeWheel").addEventListener("click", ()=> closeWheel());
    wheelBack.addEventListener("click", (e)=>{ if(e.target===wheelBack) closeWheel(); });

    function openWheel(){
      wheelBack.style.display = "flex";
      drawWheel();
      updateWheelUI();
    }
    function closeWheel(){ wheelBack.style.display = "none"; }

    const wheelCanvas = $("wheel");
    const ctx = wheelCanvas.getContext("2d");
    let wheelAngle = 0;
    let spinning = false;

    function drawWheel(){
      const W = wheelCanvas.width, H = wheelCanvas.height;
      ctx.clearRect(0,0,W,H);
      const cx = W/2, cy = H/2;
      const r = Math.min(cx,cy) - 10;
      const n = wheelItems.length;
      const slice = (Math.PI*2)/n;

      ctx.beginPath();
      ctx.arc(cx,cy,r+6,0,Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,.04)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 2;
      ctx.stroke();

      for(let i=0;i<n;i++){
        const a0 = wheelAngle + i*slice;
        const a1 = a0 + slice;

        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,a0,a1);
        ctx.closePath();

        const palette = ["#ff9800","#7c4dff","#2dd4bf","#ff5a7a","#ffc93a","#60a5fa","#34d399","#a78bfa"];
        ctx.fillStyle = palette[i % palette.length];
        ctx.globalAlpha = 0.85;
        ctx.fill();
        ctx.globalAlpha = 1;

        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(a0 + slice/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(10,14,38,.92)";
        ctx.font = "900 16px " + getComputedStyle(document.documentElement).getPropertyValue('--font');
        ctx.fillText(wheelItems[i], r - 16, 6);
        ctx.restore();
      }

      ctx.beginPath();
      ctx.arc(cx,cy,46,0,Math.PI*2);
      ctx.fillStyle = "rgba(10,14,38,.90)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.12)";
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.font = "1000 16px " + getComputedStyle(document.documentElement).getPropertyValue('--font');
      ctx.textAlign = "center";
      ctx.fillText("RUOTA", cx, cy+6);

      ctx.beginPath();
      ctx.moveTo(cx, 10);
      ctx.lineTo(cx-14, 44);
      ctx.lineTo(cx+14, 44);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,.25)";
      ctx.stroke();
    }

    function updateWheelUI(){
      const key = "wheel_spin_" + todayKey();
      const done = localStorage.getItem(key) === "1";
      $("spinBtn").disabled = done || spinning;
      $("wheelLimit").innerHTML = done
        ? "‚úÖ Giro gi√† fatto oggi su questo PC. Torna domani."
        : "1 giro al giorno per questo PC. Solo intrattenimento, gioco responsabile.";
      $("wheelWhen").textContent = formatClock(nowRome());
    }

    function wheelSetResult(text){
      $("wheelResultText").textContent = "üîç " + text + ". Verifica sempre quota al banco prima di inserire.";

      $("wheelMission").textContent = "Missione: " + (
        text.includes("2 selezioni") ? "Max 2 selezioni" :
        text.includes("singola") ? "Gioca 1 singola" :
        text.includes("1 mercato") ? "1 mercato per match" :
        "Max 3 selezioni"
      );

      $("wheelRule").textContent = "Regola: " + (
        text.includes("stop") ? "Stop dopo perdita" :
        text.includes("stake") ? "Stake ridotto" :
        "Quota al banco decide"
      );

      $("wheelFun").textContent = "Bonus: " + (text.includes("quiz") ? "Fai 1 quiz" : "Respira 10s");
    }

    $("spinBtn").addEventListener("click", ()=>{
      const key = "wheel_spin_" + todayKey();
      if (localStorage.getItem(key) === "1"){
        toast("Hai gi√† girato oggi ‚úÖ");
        updateWheelUI();
        return;
      }
      if (spinning) return;

      spinning = true;
      updateWheelUI();

      const targetIndex = hash32(todayKey() + "|VINC001") % wheelItems.length;
      const n = wheelItems.length;
      const slice = (Math.PI*2)/n;

      const targetAngle = (Math.PI*2) * 6 + (Math.PI*2) - (targetIndex*slice + slice/2);
      const start = wheelAngle;
      const delta = targetAngle - start;
      const dur = 1600;
      const t0 = performance.now();

      function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

      function anim(t){
        const p = Math.min(1, (t - t0)/dur);
        wheelAngle = start + delta * easeOutCubic(p);
        drawWheel();
        if (p < 1){
          requestAnimationFrame(anim);
        } else {
          spinning = false;
          localStorage.setItem(key, "1");
          updateWheelUI();
          wheelSetResult(wheelItems[targetIndex]);
          toast("üé° Ruota: risultato aggiornato");
        }
      }
      requestAnimationFrame(anim);
    });

    // =========================
    // QUIZ
    // =========================
    const quizBack = $("quizBack");
    $("openQuiz").addEventListener("click", ()=> openQuiz());
    $("closeQuiz").addEventListener("click", ()=> closeQuiz());
    quizBack.addEventListener("click", (e)=>{ if(e.target===quizBack) closeQuiz(); });

    const quizPool = [
      {
        q: "Qual √® la regola migliore per una multipla ‚Äúcontrollata‚Äù?",
        opts: ["10 selezioni per vincere tanto", "2‚Äì3 selezioni massimo", "Scegli a caso e via"],
        a: 1,
        ok: "Esatto ‚úÖ 2‚Äì3 selezioni ti d√† pi√π controllo.",
        no: "Quasi! La risposta migliore √®: 2‚Äì3 selezioni massimo."
      },
      {
        q: "Se la quota al banco √® diversa da quella indicativa‚Ä¶",
        opts: ["Ignoro e gioco uguale", "Riduco selezioni o passo", "Aumento lo stake"],
        a: 1,
        ok: "Giusto ‚úÖ se cambia la quota, cambia il rischio.",
        no: "Meglio: riduci selezioni o passa."
      },
      {
        q: "Contro una super favorita ospite, il 1X √®‚Ä¶",
        opts: ["Sempre tranquillissimo", "Spesso rischioso (serve quota buona)", "Garantito"],
        a: 1,
        ok: "Perfetto ‚úÖ serve prudenza e quota buona.",
        no: "No: spesso √® rischioso e dipende dalla quota."
      }
    ];

    function openQuiz(){
      quizBack.style.display = "flex";
      renderQuiz();
    }
    function closeQuiz(){ quizBack.style.display = "none"; }

    function renderQuiz(){
      const i = hash32(todayKey() + "|quiz") % quizPool.length;
      const q = quizPool[i];
      $("qTitle").textContent = q.q;
      $("qMsg").textContent = "Rispondi: √® solo intrattenimento üòä";
      const box = $("qOptions");
      box.innerHTML = "";
      q.opts.forEach((opt, idx)=>{
        const b = document.createElement("button");
        b.className = "qOpt";
        b.textContent = opt;
        b.onclick = ()=>{ $("qMsg").textContent = (idx === q.a) ? q.ok : q.no; };
        box.appendChild(b);
      });
    }

    // =========================
    // INIT
    // =========================
    (function init(){
      CURRENT_SLOT = getSlotFromURL() || localStorage.getItem("slot") || slotFromTime(nowRome());
      $("slotLabel").textContent = slotLabel(CURRENT_SLOT);
      localStorage.setItem("slot", CURRENT_SLOT);
      setSlotInURL(CURRENT_SLOT);

      loadAll(false);
      renderTicket();
    })();
  </script>
</body>
</html>
