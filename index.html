<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vincit√π ‚Ä¢ IA Portal</title>

  <style>
    :root{
      --bg1:#2b1457;
      --bg2:#0c2b36;
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#ff8a00;
      --danger:#ff4a4a;
      --ok:#4cff7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(140,70,255,.35), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(0,220,255,.18), transparent 65%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .wrap{max-width:1150px;margin:36px auto;padding:0 16px;}
    .shell{
      border:1px solid var(--stroke);
      border-radius:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 40px 120px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }
    .shell::before{
      content:"";
      position:absolute;inset:-40px;
      background:
        radial-gradient(520px 340px at 15% 10%, rgba(255,120,0,.16), transparent 60%),
        radial-gradient(620px 420px at 90% 20%, rgba(255,0,140,.12), transparent 65%),
        radial-gradient(520px 420px at 55% 95%, rgba(0,210,255,.12), transparent 60%);
      filter: blur(10px);
      pointer-events:none;
    }

    .topbar{
      position:relative;
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;
      background: rgba(10,12,18,.35);
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .logoBadge{
      width:54px;height:38px;border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      overflow:hidden;
    }
    /* LOGO TUTTO ROSSO */
    .logoText{
      font-weight:1000;
      letter-spacing:.3px;
      font-size:14px;
      color:#ff2a2a;
      text-transform:lowercase;
    }
    .brandTitle{display:flex;flex-direction:column;gap:2px;}
    .brandTitle b{font-size:16px}
    .brandTitle span{font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .chip{
      display:flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--muted); font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#4cff7a;box-shadow:0 0 16px rgba(76,255,122,.35)}
    .motto{
      width:100%;
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,.80);
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .motto b{color:rgba(255,225,170,.95)}
    .motto .tag{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.80);
      font-weight:900;
    }

    .grid{
      position:relative;
      display:grid;
      grid-template-columns: 1.35fr .9fr;
      gap:16px;
      padding:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,12,18,.35);
      border-radius:22px;
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      display:flex;align-items:center;justify-content:space-between;
      color:rgba(255,255,255,.88);
    }

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-bottom:12px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btnPrimary{
      background: linear-gradient(180deg, rgba(255,140,0,.95), rgba(255,105,0,.85));
      border-color: rgba(255,180,0,.45);
      color:#1b0f05;
      box-shadow: 0 18px 45px rgba(255,120,0,.25);
    }
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:inline-flex;gap:8px;align-items:center;
    }

    .event{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius:18px;
      padding:12px;
      margin-bottom:12px;
    }
    .eventHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .leagueLine{
      display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px;flex-wrap:wrap;
    }
    .flag{
      width:22px;height:22px;border-radius:999px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }

    .teams{
      display:flex;align-items:center;gap:10px;font-weight:1000;flex-wrap:wrap;
      margin-top:8px;
    }
    .crest{
      width:26px;height:26px;
      object-fit:contain;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      padding:3px;
    }
    .teamBadge{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-weight:1000;
      color: rgba(255,255,255,.92);
      font-size:12px;
    }
    .meta{
      font-size:12px;color:var(--muted);
      display:flex;gap:10px;align-items:center;
    }

    .markets{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 680px){
      .markets{grid-template-columns:1fr}
    }

    .market{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius:16px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .mTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .mLabel{font-weight:1000;font-size:12px}
    .mHint{font-size:11px;color:var(--muted);line-height:1.25}
    .badge{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:11px;font-weight:1000;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .badge.high{border-color: rgba(76,255,122,.35); box-shadow: 0 0 0 2px rgba(76,255,122,.08) inset;}
    .badge.mid{border-color: rgba(255,180,0,.35); box-shadow: 0 0 0 2px rgba(255,180,0,.08) inset;}
    .badge.low{border-color: rgba(255,74,74,.28); box-shadow: 0 0 0 2px rgba(255,74,74,.07) inset;}

    .mRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .oddBox{
      width:108px;
      text-align:center;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }
    .addBtn{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:1000;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
      white-space:nowrap;
    }
    .addBtn:hover{border-color: rgba(255,180,0,.40); box-shadow: 0 0 0 2px rgba(255,140,0,.10) inset;}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight:900;
    }

    .kpi{
      display:grid;grid-template-columns: repeat(3, 1fr);
      gap:10px;margin-top:10px;
    }
    .kpi .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius:16px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
    }
    .kpi .box b{display:block;color:rgba(255,255,255,.92);font-size:14px;margin-top:6px}

    .cart{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius:16px;
      padding:10px;
    }
    .cartItem{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .cartItem:last-child{margin-bottom:0}
    .cartLeft{flex:1;min-width:0}
    .cartLeft b{display:block;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cartLeft span{display:block;font-size:11px;color:var(--muted);margin-top:4px;line-height:1.25}
    .cartRight{display:flex;gap:8px;align-items:center}
    .oddInput{
      width:86px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      font-weight:1000;
      text-align:center;
      outline:none;
    }
    .rmBtn{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,74,74,.28);
      background: rgba(255,74,74,.10);
      color: rgba(255,220,220,.92);
      font-weight:1000;
      cursor:pointer;
    }

    .printBtn{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(255,180,0,.45);
      background: linear-gradient(180deg, rgba(255,160,0,.95), rgba(255,110,0,.85));
      color:#1b0f05;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 18px 45px rgba(255,120,0,.25);
    }
    .note{margin-top:10px;font-size:11px;color:rgba(255,255,255,.60);line-height:1.35}
    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,74,74,.28);
      background: rgba(255,74,74,.10);
      color: rgba(255,220,220,.92);
      font-size:12px;
    }

    /* ===== RUOTA MODAL ===== */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
      backdrop-filter: blur(6px);
    }
    .modal.open{display:flex}
    .modalCard{
      width:min(920px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,12,18,.85);
      box-shadow: 0 40px 120px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .modalTop{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .modalTop b{font-size:13px}
    .xBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:1000;
    }
    .modalBody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 860px){
      .modalBody{grid-template-columns:1fr}
    }
    .wheelWrap{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      background: rgba(0,0,0,.22);
      padding:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .wheel{
      width:320px;height:320px;
      border-radius:50%;
      border:10px solid rgba(255,255,255,.08);
      background:
        conic-gradient(
          rgba(255,140,0,.85) 0 45deg,
          rgba(0,210,255,.35) 45deg 90deg,
          rgba(255,74,74,.35) 90deg 135deg,
          rgba(76,255,122,.30) 135deg 180deg,
          rgba(140,70,255,.35) 180deg 225deg,
          rgba(255,200,120,.40) 225deg 270deg,
          rgba(0,0,0,.18) 270deg 315deg,
          rgba(255,255,255,.06) 315deg 360deg
        );
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      transform: rotate(0deg);
      transition: transform 3.2s cubic-bezier(.14,.9,.12,1);
      position:relative;
      overflow:hidden;
    }
    .wheel::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 60%);
      pointer-events:none;
    }
    .pin{
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:24px solid rgba(255,255,255,.92);
      filter: drop-shadow(0 8px 12px rgba(0,0,0,.45));
      margin-top:-6px;
    }
    .spinBtn{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,180,0,.45);
      background: linear-gradient(180deg, rgba(255,160,0,.95), rgba(255,110,0,.85));
      color:#1b0f05;
      font-weight:1000;
      cursor:pointer;
    }
    .spinBtn:disabled{
      opacity:.55; cursor:not-allowed;
    }
    .resultBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      background: rgba(0,0,0,.22);
      padding:14px;
    }
    .resultBox h4{margin:0 0 8px 0;font-size:13px}
    .result{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:rgba(255,255,255,.88);
      font-weight:900;
      line-height:1.25;
      min-height:50px;
      display:flex;align-items:center;
    }
    .small{font-size:11px;color:rgba(255,255,255,.65);line-height:1.35;margin-top:10px}

    @media print{
      body{background:#fff;color:#000}
      .wrap{margin:0;max-width:100%;padding:0}
      .shell{box-shadow:none;border:none;border-radius:0}
      .topbar,.left{display:none !important}
      .grid{grid-template-columns:1fr;padding:0}
      .right{border:none}
      .modal{display:none !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">

      <div class="topbar">
        <div class="brand">
          <div class="logoBadge" aria-label="Vincit√π">
            <div class="logoText">vincit√π</div>
          </div>
          <div class="brandTitle">
            <b>Vincit√π ‚Ä¢ IA Portal</b>
            <span>Eventi reali ‚Ä¢ quote non mostrate: si inseriscono al banco</span>
          </div>
        </div>

        <div class="chips">
          <div class="chip"><span class="dot"></span> Centro: <b id="centerChip" style="color:rgba(255,255,255,.92)">VINC001</b></div>
          <div class="chip">Agg.: <b id="updatedChip" style="color:rgba(255,255,255,.92)">‚Äî</b></div>
          <div class="chip">Fascia: <b id="slotChip" style="color:rgba(255,255,255,.92)">Sera</b></div>
          <button class="btn" id="btnWheel">üé° Ruota</button>
        </div>

        <div class="motto">
          <span class="tag">üß† Modalit√† cliente</span>
          <span id="mottoText">Carica la schedina: scegli, verifica al banco, stampa.</span>
          <b id="mottoStrong">Pochi step, grande controllo.</b>
          <span class="pill" id="badgePill">Badge: <b id="badgeText">Bronzo</b></span>
          <span class="pill" id="missionPill">Missione: <b id="missionText">Max 2 selezioni</b></span>
        </div>
      </div>

      <div class="grid">
        <div class="card left">
          <h3>‚ö° Eventi (IA) <span class="pill">Quote: <b>verifica al banco</b></span></h3>

          <div class="toolbar">
            <button class="btn btnPrimary" id="btnNew">üß† Nuovi eventi</button>
            <button class="btn" id="btnSlot">üïí Cambia fascia</button>
            <span class="pill">Eventi mostrati: <b id="count">0</b>/5</span>
          </div>

          <div id="events"></div>
          <div id="err" class="err" style="display:none;"></div>

          <div class="note">
            Supporto informativo / intrattenimento. Nessuna garanzia. Gioca responsabilmente.
            <br>‚ö†Ô∏è Le quote reali possono cambiare: inseriscile tu nella schedina dopo averle viste al banco.
          </div>
        </div>

        <div class="card right">
          <h3>üßæ Schedina</h3>

          <div class="row">
            <div style="flex:1">
              <label style="font-size:12px;color:var(--muted)">Stake (‚Ç¨)</label>
              <input id="stake" class="input" type="number" value="5" min="1" step="1" />
            </div>
            <div style="flex:1">
              <label style="font-size:12px;color:var(--muted)">Tipo</label>
              <select id="type">
                <option value="multiple">Multipla (tutte)</option>
              </select>
            </div>
          </div>

          <div class="kpi">
            <div class="box">Selezioni<b id="kSel">0</b></div>
            <div class="box">Quota totale<b id="kOdd">‚Äî</b></div>
            <div class="box">Vincita pot.<b id="kWin">‚Äî</b></div>
          </div>

          <div class="cart">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
              <div style="font-weight:1000;font-size:12px;color:rgba(255,255,255,.88)">‚úÖ Selezioni</div>
              <div class="pill" style="margin:0">‚úçÔ∏è Inserisci quota reale</div>
            </div>
            <div id="cartList" style="min-height:34px;color:rgba(255,255,255,.70);font-size:12px">
              Nessuna selezione. Aggiungi una giocata a sinistra.
            </div>
          </div>

          <button class="printBtn" id="btnPrint">üñ®Ô∏è Stampa schedina</button>

          <div class="note" id="rightNote">
            Suggerimento: fai 2‚Äì3 selezioni massimo per mantenere controllo.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL RUOTA -->
  <div class="modal" id="wheelModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <b>üé° Ruota della Fortuna (consigli & missioni)</b>
        <button class="xBtn" id="btnCloseWheel">Chiudi ‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="wheelWrap">
          <div class="pin"></div>
          <div class="wheel" id="wheel"></div>
          <button class="spinBtn" id="btnSpin">Gira la ruota</button>
          <div class="small">1 giro al giorno per questo PC. Solo intrattenimento, gioco responsabile.</div>
        </div>
        <div class="resultBox">
          <h4>üéÅ Risultato</h4>
          <div class="result" id="wheelResult">Premi ‚ÄúGira la ruota‚Äù per ottenere un consiglio bonus.</div>
          <div class="small" id="wheelInfo">Suggerimento: usa la ruota per rendere l‚Äôesperienza pi√π divertente per i clienti.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const center = (qs.get("c") || "VINC001").toUpperCase();
  let slot = (qs.get("slot") || "evening").toLowerCase(); // morning | afternoon | evening
  let seed = parseInt(qs.get("v") || (Date.now() % 100000), 10);

  const slotLabel = (s)=> s==="morning" ? "Mattina" : s==="afternoon" ? "Pomeriggio" : "Sera";
  const slotIT = (it)=> it==="mattina" ? "Mattina" : it==="pomeriggio" ? "Pomeriggio" : "Sera";

  const flagEmoji = (cc)=>{
    const map = { IT:"üáÆüáπ", EN:"üè¥", ES:"üá™üá∏", FR:"üá´üá∑", DE:"üá©üá™", NL:"üá≥üá±", PT:"üáµüáπ", SE:"üá∏üá™", TR:"üáπüá∑", PL:"üáµüá±", GR:"üá¨üá∑", CH:"üá®üá≠" };
    return map[cc] || "üåç";
  };

  const elEvents = document.getElementById("events");
  const elErr = document.getElementById("err");
  document.getElementById("centerChip").textContent = center;
  document.getElementById("slotChip").textContent = slotLabel(slot);

  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }

  // ====== MOTTO / MISSIONI / BADGE ======
  const MOTTO = [
    { t:"Scegli, verifica al banco, stampa: semplice e pulito.", b:"Poche selezioni = pi√π controllo." },
    { t:"Se una cosa non ti convince‚Ä¶ saltala.", b:"La miglior giocata √® quella che capisci." },
    { t:"Stake fisso: niente corse dietro alle perdite.", b:"Calma oggi, pi√π continuit√† domani." },
    { t:"Prima la quota reale, poi la schedina.", b:"Verifica sempre al banco." },
    { t:"Una giocata fatta bene vale pi√π di tre a caso.", b:"Qualit√† > quantit√†." }
  ];
  function bumpMotto(){
    const r = Math.floor((Date.now()/1000) % MOTTO.length);
    document.getElementById("mottoText").textContent = MOTTO[r].t;
    document.getElementById("mottoStrong").textContent = MOTTO[r].b;
  }

  const MISSIONS = [
    "Max 2 selezioni",
    "Stake fisso (5‚Ç¨)",
    "1 sola giocata ‚ÄúAlta‚Äù",
    "Inserisci tutte le quote reali",
    "Stampa solo se convinto"
  ];
  function missionOfDay(){
    const d = new Date();
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const idx = (hash(key) % MISSIONS.length);
    document.getElementById("missionText").textContent = MISSIONS[idx];
  }

  function hash(s){
    let h = 2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0);
  }

  function badgeFromPrints(n){
    if(n >= 20) return "Oro";
    if(n >= 8) return "Argento";
    return "Bronzo";
  }
  function refreshBadge(){
    const n = Number(localStorage.getItem("bb_prints") || "0");
    const b = badgeFromPrints(n);
    document.getElementById("badgeText").textContent = b;
  }

  // ====== SCHEDINA ======
  let selected = []; // {id, match, market, note, tag, odd}

  function badgeClass(tag){
    const x = (tag||"").toLowerCase();
    if(x.includes("alta")) return "high";
    if(x.includes("media")) return "mid";
    return "low";
  }

  function totalOdd(){
    let acc = 1;
    let okCount = 0;
    for(const s of selected){
      const o = Number(String(s.odd||"").replace(",", "."));
      if(Number.isFinite(o) && o > 1){
        acc *= o;
        okCount++;
      }
    }
    return { acc, okCount };
  }

  function updateKPI(){
    const stake = parseFloat(document.getElementById("stake").value || "0");
    document.getElementById("kSel").textContent = String(selected.length);

    const {acc, okCount} = totalOdd();
    if(selected.length && okCount === selected.length){
      document.getElementById("kOdd").textContent = acc.toFixed(2);
      document.getElementById("kWin").textContent = (stake * acc).toFixed(2);
    }else{
      document.getElementById("kOdd").textContent = "‚Äî";
      document.getElementById("kWin").textContent = "‚Äî";
    }
  }

  function renderCart(){
    const box = document.getElementById("cartList");
    if(!selected.length){
      box.innerHTML = "Nessuna selezione. Aggiungi una giocata a sinistra.";
      updateKPI();
      return;
    }

    box.innerHTML = "";
    selected.forEach((s, idx)=>{
      const row = document.createElement("div");
      row.className = "cartItem";
      row.innerHTML = `
        <div class="cartLeft">
          <b>${idx+1}) ${escapeHtml(s.match)} ‚Ä¢ <span style="color:rgba(255,200,120,.95)">${escapeHtml(s.market)}</span></b>
          <span>${escapeHtml(s.note || "Verifica quota reale al banco prima di confermare.")}</span>
        </div>
        <div class="cartRight">
          <input class="oddInput" inputmode="decimal" placeholder="Quota" value="${s.odd ? String(s.odd) : ""}" />
          <button class="rmBtn" title="Rimuovi">‚úñ</button>
        </div>
      `;
      row.querySelector(".oddInput").addEventListener("input", (e)=>{
        const v = (e.target.value || "").replace(",", ".");
        selected[idx].odd = v;
        updateKPI();
      });
      row.querySelector(".rmBtn").addEventListener("click", ()=>{
        selected.splice(idx,1);
        renderCart();
      });
      box.appendChild(row);
    });

    updateKPI();
  }

  function addPick(ev, market){
    const key = `${ev.id}__${market.label}`;
    if(selected.some(x => x.id === key)) return;

    selected.push({
      id: key,
      match: `${ev.home} - ${ev.away}`,
      market: market.label || "Mercato",
      note: market.note || ev.tip || "Verifica quota reale al banco e inseriscila qui.",
      tag: market.tag || "Media",
      odd: ""
    });
    renderCart();
  }

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function crestOrBadge(url, short, name){
    const safeUrl = (url || "").trim();
    if(safeUrl){
      const alt = (short || name || "Team");
      return `
        <img class="crest" src="${safeUrl}" alt="${escapeHtml(alt)}"
             onerror="this.style.display='none'; this.insertAdjacentHTML('afterend','<span class=\\'teamBadge\\'>${abbr(name, short)}</span>')">
      `;
    }
    return `<span class="teamBadge">${abbr(name, short)}</span>`;
  }

  function abbr(name, short){
    const s = (short || "").trim();
    if(s) return escapeHtml(s.slice(0,3).toUpperCase());
    const n = String(name||"").replace(/[^A-Za-z√Ä-≈æ ]/g,"").trim().split(/\s+/);
    const a = (n[0]||"X")[0] || "X";
    const b = (n.length>1 ? n[n.length-1][0] : ((n[0]||"Y")[1] || "Y"));
    return escapeHtml((a+b).toUpperCase());
  }

  function render(events, updatedAt){
    document.getElementById("updatedChip").textContent = updatedAt || "‚Äî";
    document.getElementById("count").textContent = String(events.length);
    elEvents.innerHTML = "";

    events.forEach((ev, idx)=>{
      const cc = (ev.country_code || "").toUpperCase();
      const flag = flagEmoji(cc);

      const node = document.createElement("div");
      node.className = "event";
      node.innerHTML = `
        <div class="eventHead">
          <div style="min-width:0">
            <div class="leagueLine">
              <span class="flag">${flag}</span>
              <b>${escapeHtml(ev.league || "Campionato")}</b>
              <span style="opacity:.8">‚Ä¢</span>
              <span>${escapeHtml(ev.start || "")}</span>
              <span style="opacity:.8">‚Ä¢</span>
              <span style="color:rgba(255,200,120,.95);font-weight:1000">${slotIT(ev.slot || "")}</span>
            </div>

            <div class="teams">
              ${crestOrBadge(ev.home_crest, ev.home_short, ev.home)}
              <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px">
                ${escapeHtml(ev.home)} - ${escapeHtml(ev.away)}
              </span>
              ${crestOrBadge(ev.away_crest, ev.away_short, ev.away)}
            </div>

            ${ev.tip ? `<div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,.70);line-height:1.25">üí° ${escapeHtml(ev.tip)}</div>` : ""}
          </div>
          <div class="meta">Evento ${idx+1}/5</div>
        </div>

        <div class="markets"></div>
      `;

      const mk = node.querySelector(".markets");
      (ev.markets || []).slice(0,3).forEach(m=>{
        const tag = (m.tag || "Media");
        const bClass = badgeClass(tag);

        const mNode = document.createElement("div");
        mNode.className = "market";
        mNode.innerHTML = `
          <div class="mTop">
            <div>
              <div class="mLabel">${escapeHtml(m.label || "Mercato")}</div>
              <div class="mHint">${escapeHtml(m.note || "Valutazione indicativa: verifica quota al banco.")}</div>
            </div>
            <div class="badge ${bClass}">${escapeHtml(tag)}</div>
          </div>
          <div class="mRow">
            <div class="oddBox">Verifica<br>al banco</div>
            <button class="addBtn">‚ûï Aggiungi</button>
          </div>
        `;
        mNode.querySelector(".addBtn").addEventListener("click", ()=>{
          addPick(ev, m);
          bumpMotto();
          document.getElementById("rightNote").textContent =
            "‚úÖ Inserisci la quota reale a destra: vedrai quota totale e vincita potenziale.";
        });
        mk.appendChild(mNode);
      });

      elEvents.appendChild(node);
    });
  }

  async function load(){
    elErr.style.display = "none";
    try{
      const res = await fetch("events.json?ts=" + Date.now());
      const txt = await res.text();

      let data;
      try{ data = JSON.parse(txt); }
      catch(e){ throw new Error("events.json non √® JSON valido."); }

      const all = Array.isArray(data.events) ? data.events : [];
      if(!all.length){
        throw new Error("events.json √® valido ma non contiene eventi (events=[]). Controlla GitHub Actions.");
      }

      const want = slot==="morning" ? "mattina" : slot==="afternoon" ? "pomeriggio" : "sera";
      const base = all.filter(x => (x.slot||"").toLowerCase() === want);
      const pool = base.length ? base : all;

      const rnd = mulberry32(seed);
      const idxs = pool.map((_,i)=>i);
      for(let i=idxs.length-1;i>0;i--){
        const j = Math.floor(rnd()*(i+1));
        [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
      }

      const used = new Set();
      const out = [];
      for(const i of idxs){
        const ev = pool[i];
        const key = `${ev.home}__${ev.away}__${ev.league}`;
        if(used.has(key)) continue;
        used.add(key);
        out.push(ev);
        if(out.length>=5) break;
      }

      render(out, data.updated_at);
      bumpMotto();
      missionOfDay();
      refreshBadge();

    }catch(err){
      elEvents.innerHTML = "";
      elErr.textContent = "Errore: " + (err?.message || String(err));
      elErr.style.display = "block";
    }
  }

  document.getElementById("btnNew").addEventListener("click", ()=>{
    seed = (seed + 1337) % 1000000;
    load();
    bumpMotto();
  });

  document.getElementById("btnSlot").addEventListener("click", ()=>{
    slot = slot==="morning" ? "afternoon" : slot==="afternoon" ? "evening" : "morning";
    document.getElementById("slotChip").textContent = slotLabel(slot);
    const u = new URL(location.href);
    u.searchParams.set("slot", slot);
    u.searchParams.set("v", String(seed));
    history.replaceState({}, "", u.toString());
    load();
    bumpMotto();
  });

  document.getElementById("btnPrint").addEventListener("click", ()=>{
    if(!selected.length){
      alert("Aggiungi almeno una selezione prima di stampare.");
      return;
    }
    const {okCount} = totalOdd();
    if(okCount !== selected.length){
      const go = confirm("Mancano alcune quote. Vuoi stampare lo stesso?");
      if(!go) return;
    }

    // badge: conta stampe
    const n = Number(localStorage.getItem("bb_prints") || "0") + 1;
    localStorage.setItem("bb_prints", String(n));
    refreshBadge();

    window.print();
  });

  document.getElementById("stake").addEventListener("input", updateKPI);

  // ===== RUOTA =====
  const wheelModal = document.getElementById("wheelModal");
  const wheel = document.getElementById("wheel");
  const btnWheel = document.getElementById("btnWheel");
  const btnCloseWheel = document.getElementById("btnCloseWheel");
  const btnSpin = document.getElementById("btnSpin");
  const wheelResult = document.getElementById("wheelResult");
  const wheelInfo = document.getElementById("wheelInfo");

  const PRIZES = [
    "üéØ Missione bonus: oggi fai massimo 2 selezioni.",
    "üß† Consiglio: se una quota √® troppo bassa, non forzare la multipla.",
    "‚è∏Ô∏è Pausa 20 secondi: respira e scegli una sola giocata.",
    "‚úÖ Regola d‚Äôoro: stake fisso, niente rincorse.",
    "üîç Verifica: controlla quota al banco prima di inserire.",
    "üèÖ Badge boost: stampa solo se tutte le quote sono inserite.",
    "üé≤ Modalit√† safe: scegli 1 mercato ‚ÄòAlta‚Äô e stop.",
    "üí° Tip: meglio saltare un match che inseguirlo."
  ];

  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function wheelState(){
    const key = "bb_wheel_" + todayKey();
    return {
      key,
      used: localStorage.getItem(key) === "1"
    };
  }

  function openWheel(){
    wheelModal.classList.add("open");
    wheelModal.setAttribute("aria-hidden", "false");
    const st = wheelState();
    btnSpin.disabled = st.used;
    wheelInfo.textContent = st.used
      ? "Hai gi√† girato oggi su questo PC. Domani si resetta automaticamente."
      : "1 giro al giorno. Solo intrattenimento: consigli e missioni (gioco responsabile).";
  }
  function closeWheel(){
    wheelModal.classList.remove("open");
    wheelModal.setAttribute("aria-hidden", "true");
  }

  btnWheel.addEventListener("click", openWheel);
  btnCloseWheel.addEventListener("click", closeWheel);
  wheelModal.addEventListener("click", (e)=>{ if(e.target === wheelModal) closeWheel(); });

  let spinning = false;
  btnSpin.addEventListener("click", ()=>{
    const st = wheelState();
    if(st.used || spinning) return;
    spinning = true;
    btnSpin.disabled = true;

    // esito deterministico (stabile) basato su data+centro
    const idx = hash(todayKey() + "|" + center) % PRIZES.length;

    // rotazione: fai 6 giri + offset per "settore"
    const sector = 360 / PRIZES.length;
    const targetDeg = (idx * sector) + (sector/2);
    const spins = 6*360;
    const finalDeg = spins + (360 - targetDeg);

    wheel.style.transform = `rotate(${finalDeg}deg)`;

    setTimeout(()=>{
      wheelResult.textContent = PRIZES[idx];
      localStorage.setItem(st.key, "1");
      wheelInfo.textContent = "Fatto! Domani puoi girare di nuovo su questo PC.";
      spinning = false;
      bumpMotto();
    }, 3300);
  });

  renderCart();
  load();
  bumpMotto();
  missionOfDay();
  refreshBadge();
</script>
</body>
</html>
