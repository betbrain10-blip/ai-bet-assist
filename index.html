<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vincit√π ‚Ä¢ IA Portal</title>

  <style>
    :root{
      --bg1:#2a0f5e;
      --bg2:#071a3a;

      --panel: rgba(18, 20, 44, .70);
      --panel2: rgba(26, 30, 62, .72);
      --stroke: rgba(255,255,255,.12);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.48);

      --accent:#ff9800;
      --accent2:#ffb84a;

      --ok:#2ecc71;
      --warn:#f1c40f;
      --bad:#ff5b5b;

      --r: 18px;
      --shadow: 0 16px 60px rgba(0,0,0,.38);
      --shadow2: 0 12px 30px rgba(255,152,0,.12);

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(140,70,255,.40), transparent 60%),
        radial-gradient(900px 700px at 85% 0%, rgba(0,180,255,.20), transparent 55%),
        radial-gradient(1000px 900px at 60% 85%, rgba(255,152,0,.10), transparent 55%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
    }

    .wrap{ max-width: 1280px; margin: 26px auto; padding: 0 18px 40px; }
    .shell{
      border:1px solid var(--stroke);
      border-radius: 28px;
      background: rgba(12, 14, 32, .48);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 18px 18px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), transparent);
      gap: 14px;
    }

    .brand{ display:flex; gap:12px; align-items:center; min-width: 280px; }

    /* Logo rosso come prima */
    .vlogo{
      width:36px; height:36px;
      border-radius: 12px;
      background: linear-gradient(180deg, #ff3b3b, #b70000);
      display:grid; place-items:center;
      box-shadow: 0 14px 28px rgba(255,0,0,.18);
      border: 1px solid rgba(255,255,255,.18);
      position: relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .vlogo::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(25deg);
      opacity:.35;
    }
    .vlogo span{ font-weight: 950; letter-spacing:.6px; z-index:1; }

    .brand h1{ margin:0; font-size: 16px; line-height: 1.1; font-weight: 900; letter-spacing:.2px; }
    .brand p{ margin:4px 0 0; font-size: 12px; color: var(--muted); }

    .meta{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{ width:8px;height:8px;border-radius:50%; background: var(--ok); box-shadow: 0 0 0 4px rgba(46, 204, 113, .12); }

    .content{
      display:grid;
      grid-template-columns: 1.20fr .80fr;
      gap: 16px;
      padding: 16px;
    }
    @media (max-width: 1060px){ .content{ grid-template-columns: 1fr; } .brand{ min-width: unset; } }

    .panel{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      overflow:hidden;
    }
    .panelHead{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .panelHead .title{ display:flex; align-items:center; gap:10px; font-weight:900; font-size: 13px; letter-spacing:.2px; }

    .btns{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      background: rgba(255,255,255,.05);
      padding: 9px 12px;
      border-radius: 14px;
      font-weight: 850;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      border-color: rgba(0,0,0,.12);
      color: #171717;
      box-shadow: var(--shadow2);
    }

    .subline{
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .subtag{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .topIa{
      margin: 10px 12px 0;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .topIaHead{
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .topIaHead b{ letter-spacing:.2px; }
    .topIaList{
      padding: 10px 12px 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){ .topIaList{ grid-template-columns: 1fr; } }
    .topPick{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      display:flex; flex-direction:column; gap:6px;
    }
    .topPick .row1{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; font-weight: 900; font-size: 12px; }
    .topPick .row2{ color: var(--muted); font-size: 12px; line-height: 1.32; }

    .events{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .eventCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10, 12, 26, .35);
      border-radius: 20px;
      overflow:hidden;
    }
    .eventTop{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap: 10px;
    }
    .leagueLine{ display:flex; align-items:center; gap:10px; font-size: 12px; color: var(--muted); flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }

    .teams{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px 12px;
      flex-wrap:wrap;
    }
    .crest{
      width:26px;height:26px;border-radius:50%;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .crest img{ width:100%; height:100%; object-fit:contain; }
    .teams .name{ font-weight: 950; letter-spacing:.2px; font-size: 14px; }
    .teams .vs{ color: var(--muted2); font-weight: 900; margin: 0 6px; }

    .iaBox{ padding: 0 12px 12px; display:grid; grid-template-columns: 1fr; gap: 10px; }
    .iaRow{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .iaHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .iaHeader .h{ font-weight: 950; font-size: 13px; }
    .chips{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; }
    .chip{
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space: nowrap;
    }
    .chip.ok{ border-color: rgba(46,204,113,.35); color: rgba(220,255,235,.92); background: rgba(46,204,113,.10); }
    .chip.warn{ border-color: rgba(241,196,15,.35); color: rgba(255,250,210,.95); background: rgba(241,196,15,.10); }

    .iaText{ font-size: 12px; line-height: 1.35; color: var(--muted); }

    .iaList{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 2px; }
    @media (max-width: 620px){ .iaList{ grid-template-columns: 1fr; } }

    .pick{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 9px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .pickTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .pickTop .pname{ font-weight: 950; font-size: 12px; }
    .pickTop .ptag{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space: nowrap;
    }
    .ptag.ok{ border-color: rgba(46,204,113,.35); background: rgba(46,204,113,.10); color: rgba(220,255,235,.92); }
    .ptag.warn{ border-color: rgba(241,196,15,.35); background: rgba(241,196,15,.10); color: rgba(255,250,210,.92); }
    .ptag.bad{ border-color: rgba(255,91,91,.35); background: rgba(255,91,91,.10); color: rgba(255,225,225,.95); }

    .pickNote{ font-size: 12px; color: var(--muted); line-height: 1.32; }
    .footNote{ padding: 0 12px 12px; font-size: 11px; color: var(--muted2); }

    .side{ padding: 12px; display:flex; flex-direction:column; gap: 12px; }
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      background: rgba(255,255,255,.03);
      padding: 12px;
    }
    .box h3{ margin: 0 0 8px 0; font-size: 13px; font-weight: 950; }
    .box p{ margin: 0; font-size: 12px; color: var(--muted); line-height: 1.35; }

    .bigBtn{
      width:100%;
      border: none;
      cursor:pointer;
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 950;
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      color:#151515;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: var(--shadow2);
    }
    .bigBtn:active{ transform: scale(.99); }
    .miniRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .miniPill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal ruota */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modal{
      width:min(900px, 100%);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 24px;
      background: rgba(14,16,34,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHead .t{ font-weight: 950; font-size: 13px; display:flex; gap:8px; align-items:center; }
    .close{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 950;
      font-size: 12px;
    }
    .modalBody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 880px){ .modalBody{ grid-template-columns: 1fr; } }
    canvas{ width:100%; height:auto; }
    .result{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
      min-height: 180px;
    }
    .result h4{ margin: 0 0 8px 0; font-size: 13px; font-weight: 950; }
    .result .msg{ font-size: 14px; font-weight: 950; margin-top: 6px; }
    .result .sub{ margin-top: 8px; font-size: 12px; color: var(--muted); line-height: 1.35; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="vlogo" title="Vincit√π"><span>V</span></div>
          <div>
            <h1>Vincit√π ‚Ä¢ IA Portal</h1>
            <p>QR da sala ‚Ä¢ schede partita IA ‚Ä¢ quote sempre al banco</p>
          </div>
        </div>

        <div class="meta">
          <span class="pill"><span class="dot"></span> Centro: <b id="center">VINC001</b></span>
          <span class="pill">Agg: <b id="updated">‚Äî</b></span>
          <span class="pill">Fascia: <b id="slotLabel">Sera</b></span>
        </div>
      </div>

      <div class="content">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHead">
            <div class="title">‚ö° Pronostici IA (scheda partita)</div>
            <div class="btns">
              <div class="btn primary" id="btnNew">üü† Nuovi match</div>
              <div class="btn" id="btnSlot">üïí Cambia fascia</div>
              <div class="btn" id="btnWheel">üé° Ruota</div>
            </div>
          </div>

          <div class="subline">
            <span class="subtag">Quote: <b>verifica al banco</b></span>
            <span class="subtag" id="counts">Match mostrati: ‚Äî</span>
            <span class="subtag">Rotazione: <b>3 per fascia</b> (9 al giorno)</span>
          </div>

          <div class="topIa">
            <div class="topIaHead">
              <div>‚≠ê <b>TOP IA del momento</b> (6 idee ‚Äúda sala‚Äù)</div>
              <div class="badge">Solo indicazioni ‚Ä¢ quota al banco</div>
            </div>
            <div class="topIaList" id="topIaList"></div>
          </div>

          <div class="events" id="events"></div>

          <div class="footNote">
            Supporto informativo / intrattenimento. Nessuna garanzia. Gioca responsabilmente.
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="panelHead">
            <div class="title">üßæ Modalit√† cliente</div>
            <div class="badge">QR Sala</div>
          </div>

          <div class="side">
            <div class="box">
              <h3>üéØ Regole d‚Äôoro (stile sala PRO)</h3>
              <p>
                1) Scegli <b>1‚Äì2 selezioni</b> massimo.<br>
                2) Leggi la scheda IA (ritmo/fisicit√†).<br>
                3) <b>Quota sempre al banco</b>: se non convince, passa.
              </p>
              <div class="miniRow">
                <span class="miniPill">‚úÖ 1‚Äì2 scelte max</span>
                <span class="miniPill">‚úÖ niente inseguimento</span>
                <span class="miniPill">‚úÖ quota al banco</span>
              </div>
            </div>

            <div class="box">
              <h3>üî• Suggerimento IA rapido</h3>
              <p id="tipLine">Carico i dati‚Ä¶</p>
            </div>

            <button class="bigBtn" onclick="window.print()">
              üñ®Ô∏è Stampa scheda
            </button>

            <div class="box">
              <h3>üé° Ruota disciplina (divertimento utile)</h3>
              <p>
                Non d√† pronostici: d√† <b>consigli di gestione</b>.
                Serve per far scena in sala e tenere controllo.
              </p>
              <div class="miniRow">
                <span class="miniPill">1 giro al giorno</span>
                <span class="miniPill">consigli pratici</span>
              </div>
            </div>
          </div>
        </div>
      </div><!-- content -->
    </div><!-- shell -->
  </div><!-- wrap -->

  <!-- Modal RUOTA -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="t">üé° Ruota (disciplina & controllo)</div>
        <button class="close" id="btnClose">Chiudi ‚úï</button>
      </div>
      <div class="modalBody">
        <div class="box" style="margin:0;">
          <canvas id="wheel" width="520" height="520"></canvas>
          <div class="btn primary" id="btnSpin" style="margin-top:10px; justify-content:center;">Gira la ruota</div>
          <div style="margin-top:8px; font-size:11px; color:var(--muted2);">
            1 giro al giorno per questo PC. Solo intrattenimento, gioco responsabile.
          </div>
        </div>
        <div class="result">
          <h4>üéÅ Risultato</h4>
          <div class="msg" id="wheelMsg">Premi ‚ÄúGira la ruota‚Äù.</div>
          <div class="sub" id="wheelSub">Consiglio breve, concreto, applicabile subito.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // STATE
    // =========================
    const SLOT_ORDER = ["mattina","pomeriggio","sera"];
    const PER_SLOT = 3; // <<< 3 per fascia
    let CURRENT_SLOT = "sera";
    let EVENTS_DATA = null;

    const slotNice = (s) => s === "mattina" ? "Mattina" : s === "pomeriggio" ? "Pomeriggio" : "Sera";
    const clamp01 = (x) => Math.max(0, Math.min(1, x ?? 0.5));

    function scoreTag(x){
      if (x >= 0.72) return {t:"Pi√π stabile", c:"ok"};
      if (x >= 0.52) return {t:"Prudenza", c:"warn"};
      return {t:"Rischiosa", c:"bad"};
    }

    function crestImg(url){
      if(!url) return "";
      return `<img src="${url}" alt="" loading="lazy" referrerpolicy="no-referrer" />`;
    }

    // =========================
    // ROTAZIONE (non random confuso)
    // - ogni click "Nuovi match" fa avanzare di 3
    // - stabile per fascia e giorno
    // =========================
    function todayKey(){
      return new Date().toISOString().slice(0,10);
    }
    function rotKey(slot){
      return `rot_${slot}_${todayKey()}`;
    }
    function getRot(slot){
      const v = Number(localStorage.getItem(rotKey(slot)) || "0");
      return Number.isFinite(v) ? v : 0;
    }
    function incRot(slot){
      const v = getRot(slot) + 1;
      localStorage.setItem(rotKey(slot), String(v));
      return v;
    }

    // =========================
    // PARTIZIONE EVENTI SE MATTINA/POMERIGGIO SONO VUOTE
    // (cos√¨ hai sempre 3+3+3 anche se l'API mette solo "sera")
    // =========================
    function hashStr(s){
      let h = 2166136261;
      for(let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }

    function partitionSlot(e){
      // assegna ogni evento ad una fascia in modo stabile (giorno + uniq)
      const base = (e.uniq || `${e.id}|${e.start_iso}|${e.home}|${e.away}`) + "|" + todayKey();
      const h = hashStr(base) % 3;
      return SLOT_ORDER[h];
    }

    function getSlotPool(all, slot){
      const allE = (all.events||[]);
      const native = allE.filter(e => (e.slot||"") === slot);
      if(native.length >= PER_SLOT) return native;

      // fallback: ripartisce tutto il pool
      const pool = allE.filter(e => partitionSlot(e) === slot);
      // se ancora vuoto, usa tutto
      return pool.length ? pool : allE;
    }

    function sliceRotate(pool, slot){
      const n = pool.length;
      if(!n) return [];
      const r = getRot(slot);
      const start = (r * PER_SLOT) % n;
      const out = [];
      for(let i=0;i<PER_SLOT;i++){
        out.push(pool[(start + i) % n]);
      }
      // evita duplicati se n < PER_SLOT
      const uniq = [];
      const seen = new Set();
      for(const e of out){
        const k = e.uniq || String(e.id);
        if(!seen.has(k)){
          seen.add(k);
          uniq.push(e);
        }
      }
      return uniq;
    }

    // =========================
    // SERIET√Ä: niente favorita sparata
    // =========================
    function balanceLabel(diff){
      if (diff === null || diff === undefined || Number.isNaN(diff)) {
        return { label:"Equilibrio da verificare", level:"warn" };
      }
      const a = Math.abs(diff);
      if (a < 0.20) return { label:"Match equilibrato", level:"warn" };
      if (a < 0.45) return { label:"Leggero sbilanciamento", level:"warn" };
      return { label:"Match sbilanciato", level:"ok" };
    }

    function profileFromContext(ctx){
      const tempo = ctx?.signals?.ritmo || (ctx?.tempo>=0.62 ? "Alta" : ctx?.tempo>=0.42 ? "Media" : "Bassa");
      const fis = ctx?.signals?.fisicita || (ctx?.grit>=0.62 ? "Alta" : ctx?.grit>=0.38 ? "Media" : "Bassa");

      const tempoLine =
        tempo === "Alta" ? "Ritmo alto: pi√π pressione ‚Üí pi√π corner/occasioni possibili."
        : tempo === "Media" ? "Ritmo medio: gara a fasi, pu√≤ cambiare inerzia."
        : "Ritmo basso: partita tattica, mercati Over pi√π delicati.";

      const fisLine =
        fis === "Alta" ? "Fisicit√† alta: pi√π contrasti ‚Üí attenzione cartellini."
        : fis === "Media" ? "Fisicit√† media: cartellini possibili ma non automatici."
        : "Fisicit√† bassa: cartellini meno leggibili senza info arbitro.";

      return { tempo, fis, tempoLine, fisLine };
    }

    function buildPicks(e){
      const ctx = e.context || {};
      const tempo = clamp01(ctx.tempo);
      const goals = clamp01(ctx.goals);
      const grit  = clamp01(ctx.grit);
      const corners = clamp01(ctx.corners);
      const cards = clamp01(ctx.cards);

      const sOver = scoreTag(goals*0.60 + tempo*0.40);
      const sGoal = scoreTag(goals*0.75 + tempo*0.25);
      const sCorner = scoreTag(corners*0.75 + tempo*0.25);
      const sCards  = scoreTag(cards*0.65 + grit*0.35);

      const bal = balanceLabel(ctx.diff);
      const sDC = bal.label === "Match sbilanciato" ? scoreTag(0.72) : scoreTag(0.55);

      const picks = [
        {
          name: "Over 2.5 (valuta quota)",
          tag: sOver,
          note: tempo < 0.40
            ? "Ritmo basso: Over 2.5 pi√π rischioso. Se quota non premia, meglio evitare."
            : "Se il ritmo regge e le occasioni arrivano, Over 2.5 pu√≤ avere senso. Quota decisiva."
        },
        {
          name: "Goal (Entrambe segnano)",
          tag: sGoal,
          note: goals >= 0.70
            ? "Segnale goal alto: utile se entrambe creano. Controlla come entrano in partita."
            : "Non automatico: serve pericolosit√† da entrambe. Quota e match-up contano molto."
        },
        {
          name: "Corner (es. Over 8.5/9.5)",
          tag: sCorner,
          note: corners >= 0.65
            ? "Pressione e cross: corner pi√π probabili. Ottimo mercato ‚Äúda sala‚Äù se quota ok."
            : "Corner meno garantiti: dipende da ritmo e spinta sulle fasce. Prudenza."
        },
        {
          name: "Cartellini (es. Over 4.5)",
          tag: sCards,
          note: (cards >= 0.62 || grit >= 0.62)
            ? "Duelli e contatti: aumenta rischio ammonizioni. Se hai info arbitro, ancora meglio."
            : "Senza arbitro/contesto, cartellini meno leggibili: non esagerare."
        },
        {
          name: "Doppia chance (1X o X2) ‚Äî solo se quota ok",
          tag: sDC,
          note: bal.label === "Match sbilanciato"
            ? "Match sbilanciato: la doppia chance pu√≤ dare pi√π controllo del segno secco."
            : "Match non chiarissimo: doppia chance solo se la quota al banco √® davvero conveniente."
        }
      ];

      const rank = (p) => p.tag.c === "ok" ? 3 : p.tag.c === "warn" ? 2 : 1;
      picks.sort((a,b)=> rank(b)-rank(a));
      return picks.slice(0,5);
    }

    function buildHeader(e){
      const ctx = e.context || {};
      const prof = profileFromContext(ctx);
      const bal = balanceLabel(ctx.diff);

      const headline =
        bal.label === "Match equilibrato"
          ? "Scheda IA: match equilibrato ‚Üí selezione prudente."
          : bal.label === "Leggero sbilanciamento"
            ? "Scheda IA: lieve sbilanciamento ‚Üí quota decisiva."
            : bal.label === "Match sbilanciato"
              ? "Scheda IA: match sbilanciato ‚Üí evita quote troppo basse."
              : "Scheda IA: dati da verificare ‚Üí quota decisiva.";

      const line1 = `Lettura: ${bal.label} ‚Ä¢ ${prof.tempoLine}`;
      const line2 = `${prof.fisLine} Regola: 1‚Äì2 selezioni max, quota sempre al banco.`;

      return { headline, line1, line2 };
    }

    function bestPickForMatch(e){
      const picks = buildPicks(e);
      const rank = (p) => p.tag.c === "ok" ? 3 : p.tag.c === "warn" ? 2 : 1;
      picks.sort((a,b)=> rank(b)-rank(a));
      const best = picks[0] || null;
      if(!best) return null;
      return {
        match: `${e.home_short || e.home} - ${e.away_short || e.away}`,
        pick: best.name,
        tag: best.tag,
        note: best.note
      };
    }

    function renderTopIA(all){
      const allE = (all.events||[]);
      const chosen = allE.slice().sort(()=>Math.random()-0.5).slice(0, 8);
      const list = [];
      for(const e of chosen){
        const b = bestPickForMatch(e);
        if(b) list.push(b);
      }
      const out = list.slice(0,6);
      const host = document.getElementById("topIaList");
      if(!out.length){
        host.innerHTML = `<div class="topPick"><div class="row1">Nessun dato</div><div class="row2">Carica events.json per vedere i TOP.</div></div>`;
        return;
      }
      host.innerHTML = out.map(x => `
        <div class="topPick">
          <div class="row1">
            <div>${x.match}</div>
            <div class="ptag ${x.tag.c}">${x.tag.t}</div>
          </div>
          <div class="row2"><b>${x.pick}</b> ‚Äî ${x.note}</div>
        </div>
      `).join("");
    }

    function renderEvent(e, idx, total){
      const league = e.league || e.league_code || "Calcio";
      const when = e.start || "";
      const header = buildHeader(e);
      const picks = buildPicks(e);

      const leagueBadge = `
        <span class="badge">${league}</span>
        <span class="badge">${when}</span>
        <span class="badge">Evento ${idx+1}/${total}</span>
      `;

      const pickHtml = picks.map(p => `
        <div class="pick">
          <div class="pickTop">
            <div class="pname">${p.name}</div>
            <div class="ptag ${p.tag.c}">${p.tag.t}</div>
          </div>
          <div class="pickNote">${p.note}</div>
        </div>
      `).join("");

      return `
        <div class="eventCard">
          <div class="eventTop">
            <div class="leagueLine">${leagueBadge}</div>
            <div class="badge">Quote: <b>verifica al banco</b></div>
          </div>

          <div class="teams">
            <div class="crest">${crestImg(e.home_crest)}</div>
            <div class="name">${e.home}</div>
            <div class="vs">‚Äî</div>
            <div class="crest">${crestImg(e.away_crest)}</div>
            <div class="name">${e.away}</div>
          </div>

          <div class="iaBox">
            <div class="iaRow">
              <div class="iaHeader">
                <div class="h">üß† ${header.headline}</div>
                <div class="chips">
                  <span class="chip ok">Consigli: 5</span>
                  <span class="chip warn">1‚Äì2 scelte max</span>
                  <span class="chip">Quota al banco</span>
                </div>
              </div>

              <div class="iaText">
                ${header.line1}<br>
                ${header.line2}
              </div>

              <div class="iaList">
                ${pickHtml}
              </div>
            </div>
          </div>

          <div class="footNote">
            Nota: indicazioni basate su segnali stimati (ritmo/fisicit√† + goal/corner/cartellini). Quota reale sempre al banco.
          </div>
        </div>
      `;
    }

    function buildGlobalTip(all){
      const pool = getSlotPool(all, CURRENT_SLOT);
      if(!pool.length) return "Nessun evento disponibile. Riprova pi√π tardi.";
      let c=0, k=0, t=0, n=0;
      for(const e of pool){
        const ctx = e.context;
        if(ctx){
          if(typeof ctx.cards==="number") c += ctx.cards;
          if(typeof ctx.corners==="number") k += ctx.corners;
          if(typeof ctx.tempo==="number") t += ctx.tempo;
          n++;
        }
      }
      if(!n) return "Regola: 1‚Äì2 selezioni max. Quota sempre al banco.";
      const cards = c/n, corners=k/n, tempo=t/n;

      if(corners > 0.65 && tempo > 0.55) return "Segnali favorevoli ai corner: scegli 1 match e valuta Over 8.5/9.5 solo con quota giusta al banco.";
      if(cards > 0.62) return "Giornata pi√π fisica: cartellini possibili, ma senza info arbitro meglio prudenza e stake fisso.";
      if(tempo < 0.40) return "Ritmo medio-basso: evita Over aggressivi. Meglio mercati prudenti e poche selezioni.";
      return "Giornata equilibrata: 1 match, 1‚Äì2 scelte massimo e quota al banco decisiva.";
    }

    // =========================
    // FETCH
    // =========================
    async function fetchEvents(){
      const res = await fetch("./events.json?v=" + Date.now(), {cache:"no-store"});
      if(!res.ok) throw new Error("Impossibile caricare events.json");
      return await res.json();
    }

    function getSlotFromURL(){
      const p = new URLSearchParams(location.search);
      const s = p.get("slot");
      if (SLOT_ORDER.includes(s)) return s;
      return null;
    }

    function setSlot(s){
      CURRENT_SLOT = s;
      document.getElementById("slotLabel").textContent = slotNice(s);
      const url = new URL(location.href);
      url.searchParams.set("slot", s);
      history.replaceState({}, "", url.toString());
    }

    function slotFromTime(d=new Date()){
      const h = d.getHours();
      if (h>=6 && h<12) return "mattina";
      if (h>=12 && h<18) return "pomeriggio";
      return "sera";
    }

    function cycleSlot(){
      const idx = SLOT_ORDER.indexOf(CURRENT_SLOT);
      const next = SLOT_ORDER[(idx+1) % SLOT_ORDER.length];
      setSlot(next);
      render(EVENTS_DATA);
    }

    function render(all){
      document.getElementById("updated").textContent = all.updated_at || "‚Äî";

      const pool = getSlotPool(all, CURRENT_SLOT);
      const shown = sliceRotate(pool, CURRENT_SLOT);

      document.getElementById("counts").textContent =
        `Fascia: ${slotNice(CURRENT_SLOT)} ‚Ä¢ Mostrati: ${shown.length}/${Math.max(pool.length, shown.length)}`;

      document.getElementById("tipLine").textContent = buildGlobalTip(all);

      renderTopIA(all);

      const host = document.getElementById("events");
      host.innerHTML = shown.map((e,i)=> renderEvent(e,i,shown.length)).join("");
    }

    async function load(force=false){
      if(!EVENTS_DATA || force){
        EVENTS_DATA = await fetchEvents();
      }
      render(EVENTS_DATA);
    }

    // =========================
    // BUTTONS
    // =========================
    document.getElementById("btnNew").addEventListener("click", async ()=>{
      // rotazione avanti di 3 per la fascia corrente
      incRot(CURRENT_SLOT);
      await load(false);
    });

    document.getElementById("btnSlot").addEventListener("click", ()=> cycleSlot());

    // =========================
    // WHEEL (consigli disciplina)
    // =========================
    const wheelItems = [
      { t: "Solo 1 selezione oggi", s: "Fai una singola con quota verificata. Pi√π controllo, meno ansia." },
      { t: "2 selezioni massimo", s: "Se fai multipla, fermati a 2 eventi. Qualit√† > quantit√†." },
      { t: "Passa se quota √® bassa", s: "Se la quota al banco √® troppo bassa, non forzare: cambia match." },
      { t: "Corner: servono ritmo e spinta", s: "Corner migliori con pressione e cross. Se ritmo basso, prudenza." },
      { t: "Cartellini: senza arbitro prudenza", s: "Fisicit√† aiuta, ma senza info arbitro non esagerare con Over cartellini." },
      { t: "Stake fisso", s: "Decidi uno stake (es. 5‚Ç¨) e non inseguire. Disciplina = lungo periodo." },
      { t: "Check 30 secondi", s: "Prima di giocare: 1) quota 2) mercato 3) numero selezioni. Stop." },
      { t: "Oggi obiettivo: capire", s: "Scegli 1 match e leggilo bene. Oggi vinci se non fai errori." }
    ];

    const modalBack = document.getElementById("modalBack");
    const btnClose = document.getElementById("btnClose");
    const btnSpin = document.getElementById("btnSpin");
    const btnWheel = document.getElementById("btnWheel");

    btnWheel.addEventListener("click", ()=> openWheel());
    btnClose.addEventListener("click", ()=> closeWheel());
    modalBack.addEventListener("click", (e)=> { if(e.target === modalBack) closeWheel(); });

    function openWheel(){
      modalBack.style.display = "flex";
      drawWheel();
      const saved = localStorage.getItem("wheelSaved");
      if(saved){
        const obj = JSON.parse(saved);
        document.getElementById("wheelMsg").textContent = obj.t;
        document.getElementById("wheelSub").textContent = obj.s;
      }
    }
    function closeWheel(){ modalBack.style.display = "none"; }

    function canSpinToday(){
      const key = "wheelDate";
      const today = new Date().toISOString().slice(0,10);
      return localStorage.getItem(key) !== today;
    }
    function setSpunToday(){
      const key = "wheelDate";
      const today = new Date().toISOString().slice(0,10);
      localStorage.setItem(key, today);
    }

    btnSpin.addEventListener("click", ()=> spinWheel());

    function spinWheel(){
      if(!canSpinToday()){
        document.getElementById("wheelMsg").textContent = "Hai gi√† girato oggi ‚úÖ";
        document.getElementById("wheelSub").textContent = "Riprova domani su questo PC.";
        return;
      }
      const pick = wheelItems[Math.floor(Math.random()*wheelItems.length)];
      setSpunToday();
      localStorage.setItem("wheelSaved", JSON.stringify(pick));
      document.getElementById("wheelMsg").textContent = pick.t;
      document.getElementById("wheelSub").textContent = pick.s;

      const canvas = document.getElementById("wheel");
      canvas.style.transition = "transform 1.1s cubic-bezier(.2,.9,.2,1)";
      const deg = 720 + Math.floor(Math.random()*360);
      canvas.style.transform = `rotate(${deg}deg)`;
      setTimeout(()=>{ canvas.style.transition=""; }, 1300);
    }

    function drawWheel(){
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
      const cx = W/2, cy = H/2;
      const r = Math.min(W,H)*0.42;

      ctx.clearRect(0,0,W,H);

      const colors = ["#ff9800","#2ecc71","#3498db","#9b59b6","#e67e22","#1abc9c","#e74c3c","#f1c40f"];
      const n = wheelItems.length;
      const slice = (Math.PI*2)/n;

      for(let i=0;i<n;i++){
        const a0 = i*slice - Math.PI/2;
        const a1 = a0 + slice;

        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,a0,a1);
        ctx.closePath();
        ctx.fillStyle = colors[i%colors.length];
        ctx.globalAlpha = 0.86;
        ctx.fill();

        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(a0 + slice/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(0,0,0,.86)";
        ctx.font = "900 14px ui-sans-serif, system-ui";
        ctx.fillText(wheelItems[i].t, r-12, 6);
        ctx.restore();
      }

      ctx.globalAlpha = 1;
      ctx.beginPath();
      ctx.arc(cx,cy,r*0.12,0,Math.PI*2);
      ctx.fillStyle = "rgba(15,18,38,.9)";
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(cx, cy-r-20);
      ctx.lineTo(cx-16, cy-r+10);
      ctx.lineTo(cx+16, cy-r+10);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.fill();
    }

    // =========================
    // INIT
    // =========================
    (async function init(){
      const urlSlot = getSlotFromURL();
      setSlot(urlSlot || slotFromTime(new Date()));
      try{
        await load(true);
      }catch(err){
        document.getElementById("events").innerHTML =
          `<div class="eventCard" style="padding:12px;">
             <b>Errore:</b> non riesco a leggere <code>events.json</code>.<br>
             <span style="color:var(--muted)">${String(err)}</span>
           </div>`;
      }
    })();
  </script>
</body>
</html>
