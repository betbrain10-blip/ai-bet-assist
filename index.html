<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vincit√π ‚Ä¢ IA Portal</title>

  <style>
    :root{
      --bg1:#2a0f5e;
      --bg2:#0b244a;
      --panel: rgba(20, 23, 44, .72);
      --panel2: rgba(30, 33, 62, .72);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.48);
      --accent:#ff9800;
      --accent2:#ffb03a;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --bad:#ff5b5b;

      --r: 18px;
      --shadow: 0 14px 50px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(140,70,255,.38), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(0,180,255,.18), transparent 55%),
        linear-gradient(120deg, var(--bg1), var(--bg2));
    }

    .wrap{
      max-width: 1240px;
      margin: 28px auto;
      padding: 0 18px 40px;
    }

    .shell{
      border:1px solid var(--stroke);
      border-radius: 26px;
      background: rgba(12, 14, 32, .45);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 18px 18px 14px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      gap: 14px;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      min-width: 280px;
    }

    /* Logo "V" rosso come prima */
    .vlogo{
      width:34px; height:34px;
      border-radius: 10px;
      background: linear-gradient(180deg, #ff3b3b, #b70000);
      display:grid; place-items:center;
      box-shadow: 0 10px 24px rgba(255,0,0,.18);
      border: 1px solid rgba(255,255,255,.18);
      flex: 0 0 auto;
    }
    .vlogo span{
      font-weight: 900;
      letter-spacing:.5px;
    }

    .brand h1{
      margin:0;
      font-size: 16px;
      line-height: 1.1;
      font-weight: 800;
    }
    .brand p{
      margin:4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(46, 204, 113, .12);
    }

    .content{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      padding: 16px;
    }

    @media (max-width: 1060px){
      .content{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      overflow:hidden;
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--stroke);
    }
    .panelHead .title{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      font-size: 13px;
    }

    .btns{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      color: var(--text);
      background: rgba(255,255,255,.05);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 750;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.08); }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      border-color: rgba(0,0,0,.1);
      color: #1b1b1b;
    }

    .subline{
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .subtag{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    /* Cards eventi */
    .events{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .eventCard{
      border:1px solid var(--stroke);
      background: rgba(10, 12, 26, .35);
      border-radius: 18px;
      overflow:hidden;
    }

    .eventTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap: 10px;
    }

    .leagueLine{
      display:flex; align-items:center; gap:10px;
      font-size: 12px;
      color: var(--muted);
      flex-wrap:wrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }

    .teams{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px 12px;
    }
    .crest{
      width:26px;height:26px;border-radius:50%;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .crest img{ width:100%; height:100%; object-fit:contain; }
    .teams .name{
      font-weight:900;
      letter-spacing:.2px;
      font-size: 14px;
    }
    .teams .vs{
      color: var(--muted2);
      font-weight: 800;
      margin: 0 6px;
    }

    .iaBox{
      padding: 0 12px 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .iaRow{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .iaHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .iaHeader .h{
      font-weight: 900;
      font-size: 13px;
    }
    .chips{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space: nowrap;
    }
    .chip.ok{ border-color: rgba(46,204,113,.35); color: rgba(210,255,230,.92); background: rgba(46,204,113,.10); }
    .chip.warn{ border-color: rgba(241,196,15,.35); color: rgba(255,248,210,.95); background: rgba(241,196,15,.10); }
    .chip.bad{ border-color: rgba(255,91,91,.35); color: rgba(255,220,220,.95); background: rgba(255,91,91,.10); }

    .iaText{
      font-size: 12px;
      line-height: 1.35;
      color: var(--muted);
    }

    .iaList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 2px;
    }
    @media (max-width: 620px){
      .iaList{ grid-template-columns: 1fr; }
    }

    .pick{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 9px 10px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .pickTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pickTop .pname{
      font-weight: 900;
      font-size: 12px;
    }
    .pickTop .ptag{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space: nowrap;
    }
    .ptag.ok{ border-color: rgba(46,204,113,.35); background: rgba(46,204,113,.10); color: rgba(220,255,235,.92); }
    .ptag.warn{ border-color: rgba(241,196,15,.35); background: rgba(241,196,15,.10); color: rgba(255,250,210,.92); }
    .ptag.bad{ border-color: rgba(255,91,91,.35); background: rgba(255,91,91,.10); color: rgba(255,225,225,.95); }

    .pickNote{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.32;
    }

    .footNote{
      padding: 0 12px 12px;
      font-size: 11px;
      color: var(--muted2);
    }

    /* Panel destro: divertimenti leggeri */
    .side{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .box{
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding: 12px;
    }
    .box h3{
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 900;
    }
    .box p{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .bigBtn{
      width:100%;
      border: none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 12px;
      font-weight: 900;
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      color:#1b1b1b;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 10px 24px rgba(255,152,0,.18);
    }
    .bigBtn:active{ transform: scale(.99); }

    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .miniPill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal ruota */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modal{
      width:min(900px, 100%);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      background: rgba(14,16,34,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHead .t{
      font-weight: 900;
      font-size: 13px;
      display:flex; gap:8px; align-items:center;
    }
    .close{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
    }
    .modalBody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 880px){
      .modalBody{ grid-template-columns: 1fr; }
    }
    canvas{ width:100%; height:auto; }
    .result{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 12px;
      min-height: 180px;
    }
    .result h4{
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 900;
    }
    .result .msg{
      font-size: 14px;
      font-weight: 900;
      margin-top: 6px;
    }
    .result .sub{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="vlogo" title="Vincit√π"><span>V</span></div>
          <div>
            <h1>Vincit√π ‚Ä¢ IA Portal</h1>
            <p>Eventi reali ‚Ä¢ pronostici IA ‚Äúscheda partita‚Äù ‚Ä¢ quota sempre al banco</p>
          </div>
        </div>

        <div class="meta">
          <span class="pill"><span class="dot"></span> Centro: <b id="center">VINC001</b></span>
          <span class="pill">Agg: <b id="updated">‚Äî</b></span>
          <span class="pill">Fascia: <b id="slotLabel">Sera</b></span>
        </div>
      </div>

      <div class="content">
        <!-- LEFT -->
        <div class="panel">
          <div class="panelHead">
            <div class="title">‚ö° Eventi (IA)</div>
            <div class="btns">
              <div class="btn primary" id="btnNew">üü† Nuovi eventi</div>
              <div class="btn" id="btnSlot">üïí Cambia fascia</div>
              <div class="btn" id="btnWheel">üé° Ruota</div>
            </div>
          </div>

          <div class="subline">
            <span class="subtag">Quote: <b>verifica al banco</b></span>
            <span class="subtag" id="counts">Eventi mostrati: ‚Äî</span>
            <span class="subtag">Modalit√†: <b>chiara & informativa</b></span>
          </div>

          <div class="events" id="events"></div>

          <div class="footNote">
            Supporto informativo / intrattenimento. Nessuna garanzia. Gioca responsabilmente.
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="panelHead">
            <div class="title">üßæ Scheda</div>
            <div class="badge">Modalit√† cliente</div>
          </div>

          <div class="side">
            <div class="box">
              <h3>üéØ Come usarlo (semplice)</h3>
              <p>
                Scegli 1‚Äì2 match, leggi la scheda IA e poi <b>controlla quota reale al banco</b>.
                Qui trovi idee + motivazioni (non quote).
              </p>
              <div class="miniRow">
                <span class="miniPill">‚úÖ 1‚Äì2 scelte max</span>
                <span class="miniPill">‚úÖ quota sempre al banco</span>
                <span class="miniPill">‚úÖ pi√π controllo</span>
              </div>
            </div>

            <div class="box">
              <h3>üî• Suggerimento IA del momento</h3>
              <p id="tipLine">Carico i dati‚Ä¶</p>
            </div>

            <button class="bigBtn" onclick="window.print()">
              üñ®Ô∏è Stampa scheda
            </button>

            <div class="box">
              <h3>üé≤ Mini-divertimento</h3>
              <p>
                La ruota d√† <b>consigli di gestione</b> (non pronostici).
                Ti aiuta a mantenere disciplina e divertirti senza inseguire.
              </p>
              <div class="miniRow">
                <span class="miniPill">1 giro al giorno</span>
                <span class="miniPill">consigli rapidi</span>
              </div>
            </div>
          </div>
        </div>
      </div><!-- content -->
    </div><!-- shell -->
  </div><!-- wrap -->

  <!-- Modal RUOTA -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="t">üé° Ruota della Fortuna (consigli & disciplina)</div>
        <button class="close" id="btnClose">Chiudi ‚úï</button>
      </div>
      <div class="modalBody">
        <div class="box" style="margin:0;">
          <canvas id="wheel" width="520" height="520"></canvas>
          <div class="btn primary" id="btnSpin" style="margin-top:10px; justify-content:center;">Gira la ruota</div>
          <div style="margin-top:8px; font-size:11px; color:var(--muted2);">
            1 giro al giorno per questo PC. Solo intrattenimento, gioco responsabile.
          </div>
        </div>
        <div class="result">
          <h4>üéÅ Risultato</h4>
          <div class="msg" id="wheelMsg">Premi ‚ÄúGira la ruota‚Äù.</div>
          <div class="sub" id="wheelSub">
            Consiglio pratico, breve e applicabile subito.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // STATE
    // =========================
    const SLOT_ORDER = ["mattina","pomeriggio","sera"];
    let CURRENT_SLOT = "sera";
    let EVENTS_DATA = null;

    const slotNice = (s) => s === "mattina" ? "Mattina" : s === "pomeriggio" ? "Pomeriggio" : "Sera";

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function tagToClass(tag){
      const t = (tag||"").toLowerCase();
      if (t.includes("alta") || t.includes("stabile")) return "ok";
      if (t.includes("media") || t.includes("prudenza")) return "warn";
      if (t.includes("bassa") || t.includes("risch")) return "bad";
      return "";
    }

    // =========================
    // FETCH EVENTS
    // =========================
    async function fetchEvents(){
      const res = await fetch("./events.json?v=" + Date.now(), {cache:"no-store"});
      if(!res.ok) throw new Error("Impossibile caricare events.json");
      return await res.json();
    }

    function getSlotFromURL(){
      const p = new URLSearchParams(location.search);
      const s = p.get("slot");
      if (SLOT_ORDER.includes(s)) return s;
      return null;
    }

    function setSlot(s){
      CURRENT_SLOT = s;
      document.getElementById("slotLabel").textContent = slotNice(s);
      const url = new URL(location.href);
      url.searchParams.set("slot", s);
      history.replaceState({}, "", url.toString());
    }

    function slotFromTimeRome(d=new Date()){
      // fallback: scegli slot in base all'ora locale
      const h = d.getHours();
      if (h>=6 && h<12) return "mattina";
      if (h>=12 && h<18) return "pomeriggio";
      return "sera";
    }

    function eventsForSlot(all, slot){
      const evs = (all.events||[]).filter(e => (e.slot||"") === slot);
      // se vuoto, fallback: prendiamo i primi 5 e mostriamo comunque (capita quando API ha solo sera)
      if (evs.length) return evs;
      return (all.events||[]).slice(0,5);
    }

    function pickN(evs, n=5){
      // shuffle leggero deterministico per "Nuovi eventi"
      const a = evs.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a.slice(0, n);
    }

    // =========================
    // IA LOGIC (CREDIBILE)
    // usa SOLO i campi che hai in events.json
    // =========================
    function buildReadableProfile(ctx){
      // ctx: tempo/goals/grit/corners/cards + signals
      const tempo = ctx?.signals?.ritmo || (ctx?.tempo>=0.62 ? "Alta" : ctx?.tempo>=0.42 ? "Media" : "Bassa");
      const eq = ctx?.signals?.equilibrio || "Equilibrio";
      const fis = ctx?.signals?.fisicita || (ctx?.grit>=0.62 ? "Alta" : ctx?.grit>=0.38 ? "Media" : "Bassa");

      // Frasi realistiche: niente ‚Äú1X tranquillo col Barca‚Äù
      const tempoLine =
        tempo === "Alta" ? "Ritmo alto: probabili fasi offensive e pressione costante."
        : tempo === "Media" ? "Ritmo medio: partita a fasi, pu√≤ accendersi a tratti."
        : "Ritmo basso: gara pi√π tattica, serve selezione prudente.";

      const eqLine =
        eq.includes("Favorita casa") ? "Favorita in casa: attenzione a quote molto basse."
        : eq.includes("Favorita ospite") ? "Favorita ospite: occhio a gestione e coperture."
        : "Match equilibrato: maggiore variabilit√†, meglio 1‚Äì2 scelte massimo.";

      const fisLine =
        fis === "Alta" ? "Fisicit√† alta: contatti e duelli, pi√π rischio cartellini."
        : fis === "Media" ? "Fisicit√† media: qualche cartellino possibile."
        : "Fisicit√† bassa: cartellini meno ‚Äúautomatici‚Äù.";

      return { tempo, eq, fis, tempoLine, eqLine, fisLine };
    }

    function suggestPicks(e){
      const ctx = e.context || {};
      const prof = buildReadableProfile(ctx);

      const corners = clamp01(ctx.corners ?? 0.5);
      const cards = clamp01(ctx.cards ?? 0.5);
      const goals = clamp01(ctx.goals ?? 0.5);

      // Tags credibili (non ‚Äúsicuro‚Äù): Stabile / Prudenza / Rischiosa
      const tagFrom = (x, bias=0) => {
        const v = x + bias;
        if (v >= 0.70) return {t:"Pi√π stabile", c:"ok"};
        if (v >= 0.50) return {t:"Prudenza", c:"warn"};
        return {t:"Rischiosa", c:"bad"};
      };

      // 1X2: se segnala favorita casa/ospite -> 1X o X2
      let pick1X2 = null;
      if ((ctx.signals?.equilibrio||"").includes("Favorita casa")){
        pick1X2 = {
          name: "1X (copertura casa)",
          tag: tagFrom(0.66, +0.06),
          note: "Se la favorita √® in casa, 1X √® spesso pi√π ‚Äúcontrollabile‚Äù del segno 1 secco. Verifica quota al banco."
        };
      } else if ((ctx.signals?.equilibrio||"").includes("Favorita ospite")){
        pick1X2 = {
          name: "X2 (copertura ospite)",
          tag: tagFrom(0.66, +0.04),
          note: "Se la favorita √® ospite, X2 pu√≤ ridurre il rischio rispetto al 2 secco. Verifica quota al banco."
        };
      } else {
        pick1X2 = {
          name: "Doppia chance (valuta 1X o X2)",
          tag: tagFrom(0.52, -0.02),
          note: "Match equilibrato: scegli la doppia chance solo se la quota al banco √® davvero conveniente."
        };
      }

      // Over/Goal: dipende da goals + tempo
      const overTag = tagFrom((goals*0.65 + (ctx.tempo??0.5)*0.35));
      const bttsTag = tagFrom((goals*0.75 + (Math.abs(ctx.diff??0)*-0.10)));
      const cornerTag = tagFrom(corners*0.8 + (ctx.tempo??0.5)*0.2);
      const cardTag = tagFrom(cards*0.75 + (ctx.grit??0.5)*0.25);

      const picks = [
        {
          name: "Over 2.5 (valuta quota)",
          tag: overTag,
          note: prof.tempo === "Alta"
            ? "Ritmo alto: aumenta la probabilit√† di occasioni. Gioca solo se la quota al banco √® in linea."
            : prof.tempo === "Media"
              ? "Ritmo medio: Over possibile ma dipende dalla qualit√† delle occasioni. Quota decisiva."
              : "Ritmo basso: Over 2.5 pi√π rischioso; valuta alternative (Over 1.5 / live)."
        },
        {
          name: "Goal (Entrambe segnano)",
          tag: bttsTag,
          note: goals >= 0.70
            ? "Segnali goal alti: utile se entrambe creano. Verifica formazione/approccio al banco."
            : "Goal non automatico: serve pericolosit√† da entrambe. Quota e match-up contano molto."
        },
        {
          name: "Corner (es. Over 8.5/9.5)",
          tag: cornerTag,
          note: corners >= 0.65
            ? "Pressione e cross: corner pi√π probabili. Ottimo mercato ‚Äúda sala‚Äù se quota giusta."
            : "Corner non garantiti: dipende da ritmo e spinta sulle fasce. Valuta prudenza."
        },
        {
          name: "Cartellini (es. Over 4.5)",
          tag: cardTag,
          note: (cards >= 0.62 || prof.fis === "Alta")
            ? "Fisicit√†/agonismo: pi√π duelli ‚Üí pi√π rischio ammonizioni. Occhio arbitro se disponibile."
            : "Cartellini meno leggibili: senza dati arbitro meglio non esagerare con questo mercato."
        },
        pick1X2
      ];

      // Ordina: pi√π ‚Äústabile‚Äù sopra
      const score = (p) => p.tag.c === "ok" ? 3 : p.tag.c === "warn" ? 2 : 1;
      picks.sort((a,b)=> score(b)-score(a));

      // 5 pronostici ‚Äúseri‚Äù per match
      return picks.slice(0,5);
    }

    function buildHeaderSentence(e){
      const ctx = e.context || {};
      const prof = buildReadableProfile(ctx);

      // headline credibile
      let headline = "Match da leggere con calma.";
      if ((ctx.signals?.equilibrio||"").includes("Favorita ospite")) headline = "Favorita ospite (gap evidente): occhio gestione.";
      if ((ctx.signals?.equilibrio||"").includes("Favorita casa")) headline = "Favorita in casa: quota spesso bassa, valuta coperture.";
      if ((ctx.signals?.equilibrio||"") === "Equilibrio") headline = "Match equilibrato: 1‚Äì2 scelte massimo.";

      // micro-regola
      const rule = "Regola: 1‚Äì2 selezioni max, quota sempre al banco.";

      // arbitro: solo se esiste
      let refLine = "";
      if (e.referee && e.referee.name){
        refLine = `Arbitro: ${e.referee.name}`;
      }

      const line2 = `Segnali: ritmo ${prof.tempo} ‚Ä¢ ${prof.eq.toLowerCase()} ‚Ä¢ fisicit√† ${prof.fis}.`;
      const tip = "Tip banco: se quota non convince, riduci selezioni o passa.";

      return { headline, line2, tip, rule, refLine };
    }

    // =========================
    // RENDER
    // =========================
    function crestImg(url){
      if(!url) return "";
      return `<img src="${url}" alt="" loading="lazy" referrerpolicy="no-referrer" />`;
    }

    function renderEvent(e, idx, total){
      const h = buildHeaderSentence(e);
      const picks = suggestPicks(e);
      const league = e.league || e.league_code || "Calcio";
      const when = e.start || "";

      const leagueBadge = `
        <span class="badge">${league}</span>
        <span class="badge">${when}</span>
        <span class="badge">Evento ${idx+1}/${total}</span>
      `;

      const chips = [];
      const ctx = e.context || {};
      const prof = buildReadableProfile(ctx);
      chips.push(`<span class="chip">${prof.tempoLine}</span>`);
      chips.push(`<span class="chip">${prof.eqLine}</span>`);
      chips.push(`<span class="chip">${prof.fisLine}</span>`);

      const pickHtml = picks.map(p => `
        <div class="pick">
          <div class="pickTop">
            <div class="pname">${p.name}</div>
            <div class="ptag ${p.tag.c}">${p.tag.t}</div>
          </div>
          <div class="pickNote">${p.note}</div>
        </div>
      `).join("");

      return `
        <div class="eventCard">
          <div class="eventTop">
            <div class="leagueLine">${leagueBadge}</div>
            <div class="badge">Quote: <b>verifica al banco</b></div>
          </div>

          <div class="teams">
            <div class="crest">${crestImg(e.home_crest)}</div>
            <div class="name">${e.home}</div>
            <div class="vs">‚Äî</div>
            <div class="crest">${crestImg(e.away_crest)}</div>
            <div class="name">${e.away}</div>
          </div>

          <div class="iaBox">
            <div class="iaRow">
              <div class="iaHeader">
                <div class="h">üß† Scheda IA: ${h.headline}</div>
                <div class="chips">
                  <span class="chip ok">Consigli: 5</span>
                  <span class="chip warn">1‚Äì2 scelte max</span>
                  <span class="chip">Quota al banco</span>
                </div>
              </div>

              <div class="iaText">
                ${h.line2}<br>
                ${h.refLine ? `<b>${h.refLine}</b><br>` : ``}
                ${h.tip}<br>
                <b>${h.rule}</b>
              </div>

              <div class="iaList">
                ${pickHtml}
              </div>
            </div>
          </div>

          <div class="footNote">
            Nota: sono indicazioni basate su segnali stimati (ritmo/equilibrio/fisicit√† + corner/cartellini). Quota reale sempre al banco.
          </div>
        </div>
      `;
    }

    function render(all){
      document.getElementById("updated").textContent = all.updated_at || "‚Äî";

      const slot = CURRENT_SLOT;
      const evs = eventsForSlot(all, slot);
      const chosen = pickN(evs, 5);

      document.getElementById("counts").textContent = `Eventi mostrati: ${chosen.length} / ${evs.length || 0}`;

      const host = document.getElementById("events");
      host.innerHTML = chosen.map((e,i)=> renderEvent(e,i,chosen.length)).join("");

      // Tip dinamico credibile
      const tip = buildGlobalTip(all);
      document.getElementById("tipLine").textContent = tip;
    }

    function buildGlobalTip(all){
      const evs = eventsForSlot(all, CURRENT_SLOT);
      if(!evs.length) return "Nessun evento in questa fascia. Prova ‚ÄúCambia fascia‚Äù.";
      // calcola media di corner/cards
      let c=0, k=0, n=0;
      for(const e of evs){
        if(e.context){
          if(typeof e.context.cards==="number"){ c += e.context.cards; }
          if(typeof e.context.corners==="number"){ k += e.context.corners; }
          n++;
        }
      }
      if(!n) return "Suggerimento: 1‚Äì2 selezioni max. Quota sempre al banco.";
      const cards = c/n, corners=k/n;

      if(corners > 0.65 && cards > 0.62) return "Oggi segnali ‚Äúmercati da sala‚Äù: corner e cartellini interessanti. Scegli 1 match e controlla la quota al banco.";
      if(corners > 0.65) return "Segnale corner sopra media: valuta Over 8.5/9.5 corner, ma solo con quota al banco giusta.";
      if(cards > 0.62) return "Segnale fisicit√†/cartellini: valuta Over 4.5 cartellini (se disponibile anche info arbitro).";
      return "Giornata pi√π ‚Äútattica‚Äù: meglio doppia chance o mercati prudenti. 1‚Äì2 scelte massimo.";
    }

    // =========================
    // UI EVENTS
    // =========================
    async function load(force=false){
      if(!EVENTS_DATA || force){
        EVENTS_DATA = await fetchEvents();
      }
      render(EVENTS_DATA);
    }

    function cycleSlot(){
      const idx = SLOT_ORDER.indexOf(CURRENT_SLOT);
      const next = SLOT_ORDER[(idx+1) % SLOT_ORDER.length];
      setSlot(next);
      render(EVENTS_DATA);
    }

    document.getElementById("btnNew").addEventListener("click", ()=> load(true));
    document.getElementById("btnSlot").addEventListener("click", ()=> cycleSlot());
    document.getElementById("btnWheel").addEventListener("click", ()=> openWheel());

    // =========================
    // WHEEL (consigli veri, non ‚Äúvuoti‚Äù)
    // =========================
    const wheelItems = [
      { t: "Solo 1 selezione oggi", s: "Fai una singola, quota verificata. Pi√π controllo, meno ansia." },
      { t: "2 selezioni massimo", s: "Se fai multipla, fermati a 2 eventi. Meglio qualit√† che quantit√†." },
      { t: "Passa se quota √® bassa", s: "Se la quota al banco √® troppo bassa, non forzare: cambia match." },
      { t: "Corner: scegli match con ritmo", s: "Corner migliori con pressione e ritmo. Se ritmo basso, prudenza." },
      { t: "Cartellini: occhio fisicit√†", s: "Cartellini pi√π probabili con fisicit√† alta. Senza arbitro, non esagerare." },
      { t: "Gestione stake: fisso", s: "Metti stake fisso (es. 5‚Ç¨) e non inseguire. Disciplina = lungo periodo." },
      { t: "Check 30 secondi", s: "Prima di giocare: 1) quota 2) mercato 3) numero selezioni. Stop." },
      { t: "Divertimento smart", s: "Scegli un match e leggilo: oggi l‚Äôobiettivo √® capire, non ‚Äúsparare‚Äù." },
    ];

    const modalBack = document.getElementById("modalBack");
    const btnClose = document.getElementById("btnClose");
    const btnSpin = document.getElementById("btnSpin");

    btnClose.addEventListener("click", ()=> closeWheel());
    modalBack.addEventListener("click", (e)=> { if(e.target === modalBack) closeWheel(); });

    function openWheel(){
      modalBack.style.display = "flex";
      drawWheel();
      // mostra ultimo risultato se esiste
      const saved = localStorage.getItem("wheelSaved");
      if(saved){
        const obj = JSON.parse(saved);
        document.getElementById("wheelMsg").textContent = obj.t;
        document.getElementById("wheelSub").textContent = obj.s;
      }
    }
    function closeWheel(){ modalBack.style.display = "none"; }

    function canSpinToday(){
      const key = "wheelDate";
      const today = new Date().toISOString().slice(0,10);
      return localStorage.getItem(key) !== today;
    }
    function setSpunToday(){
      const key = "wheelDate";
      const today = new Date().toISOString().slice(0,10);
      localStorage.setItem(key, today);
    }

    btnSpin.addEventListener("click", ()=> spinWheel());

    function spinWheel(){
      if(!canSpinToday()){
        document.getElementById("wheelMsg").textContent = "Hai gi√† girato oggi ‚úÖ";
        document.getElementById("wheelSub").textContent = "Riprova domani su questo PC.";
        return;
      }
      const pick = wheelItems[Math.floor(Math.random()*wheelItems.length)];
      setSpunToday();
      localStorage.setItem("wheelSaved", JSON.stringify(pick));
      document.getElementById("wheelMsg").textContent = pick.t;
      document.getElementById("wheelSub").textContent = pick.s;

      // animazione: rotazione canvas finta
      const canvas = document.getElementById("wheel");
      canvas.style.transition = "transform 1.1s cubic-bezier(.2,.9,.2,1)";
      const deg = 720 + Math.floor(Math.random()*360);
      canvas.style.transform = `rotate(${deg}deg)`;
      setTimeout(()=>{ canvas.style.transition=""; }, 1300);
    }

    function drawWheel(){
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");
      const W = canvas.width, H = canvas.height;
      const cx = W/2, cy = H/2;
      const r = Math.min(W,H)*0.42;

      ctx.clearRect(0,0,W,H);

      const colors = ["#ff9800","#2ecc71","#3498db","#9b59b6","#e67e22","#1abc9c","#e74c3c","#f1c40f"];
      const n = wheelItems.length;
      const slice = (Math.PI*2)/n;

      for(let i=0;i<n;i++){
        const a0 = i*slice - Math.PI/2;
        const a1 = a0 + slice;

        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,a0,a1);
        ctx.closePath();
        ctx.fillStyle = colors[i%colors.length];
        ctx.globalAlpha = 0.85;
        ctx.fill();

        // testo
        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(a0 + slice/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(0,0,0,.85)";
        ctx.font = "bold 14px ui-sans-serif, system-ui";
        ctx.fillText(wheelItems[i].t, r-12, 6);
        ctx.restore();
      }

      // cerchio interno
      ctx.globalAlpha = 1;
      ctx.beginPath();
      ctx.arc(cx,cy,r*0.12,0,Math.PI*2);
      ctx.fillStyle = "rgba(15,18,38,.9)";
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.stroke();

      // puntatore
      ctx.beginPath();
      ctx.moveTo(cx, cy-r-20);
      ctx.lineTo(cx-16, cy-r+10);
      ctx.lineTo(cx+16, cy-r+10);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,.9)";
      ctx.fill();
    }

    // =========================
    // INIT
    // =========================
    (async function init(){
      const urlSlot = getSlotFromURL();
      setSlot(urlSlot || slotFromTimeRome(new Date()));
      try{
        await load(true);
      }catch(err){
        document.getElementById("events").innerHTML =
          `<div class="eventCard" style="padding:12px;">
             <b>Errore:</b> non riesco a leggere <code>events.json</code>.<br>
             <span style="color:var(--muted)">${String(err)}</span>
           </div>`;
      }
    })();
  </script>
</body>
</html>
