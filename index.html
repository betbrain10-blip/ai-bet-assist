<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vincit√π ‚Ä¢ IA Portal</title>

  <style>
    :root{
      --bg1:#3b1d7a;
      --bg2:#0b1a3f;
      --panel: rgba(20, 23, 44, .72);
      --panel2: rgba(30, 33, 62, .72);
      --stroke: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.65);
      --text: rgba(255,255,255,.92);
      --accent:#ff8a00;
      --green:#35d07f;
      --yellow:#f3c24b;
      --red:#ff4b5c;
      --chip: rgba(255,255,255,.08);
      --shadow: 0 12px 50px rgba(0,0,0,.35);
      --r: 18px;
      --r2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(140,60,255,.35), transparent 55%),
        radial-gradient(900px 600px at 85% 30%, rgba(0,195,255,.18), transparent 55%),
        linear-gradient(115deg, var(--bg1), var(--bg2));
    }

    a{color:inherit}

    .wrap{
      width:min(1100px, 96vw);
      margin: 26px auto 40px auto;
      padding: 18px;
      border-radius: 26px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 10px 14px 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }

    .logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .logo-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .logo-badge span{
      font-weight: 900;
      color: #ff2d2d; /* solo rossa come prima */
      font-size: 18px;
      transform: translateY(-.5px);
    }
    .logo-title{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .logo-title b{
      font-size: 16px;
    }
    .logo-title small{
      color: var(--muted);
      font-weight: 600;
      font-size: 11px;
      margin-top: 4px;
    }

    .statusRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      font-weight: 700;
      white-space:nowrap;
    }
    .dot{
      width: 9px;
      height: 9px;
      border-radius: 99px;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(53,208,127,.12);
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.90);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 12px;
      transition: transform .05s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }

    .btn-accent{
      border: 1px solid rgba(255,140,0,.45);
      background: rgba(255,138,0,.22);
      color: rgba(255,255,255,.92);
    }
    .btn-accent:hover{ background: rgba(255,138,0,.28); }

    .btn-big{
      width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 900;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      padding: 4px 6px 10px 6px;
    }

    .card{
      border-radius: var(--r);
      background: var(--panel);
      border: 1px solid var(--stroke);
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
    }

    .card h3{
      margin: 0;
      font-size: 13px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
    }
    .subnote{
      margin-top: 8px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.25;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }
    .toolbar .left, .toolbar .right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 800;
    }

    /* LISTA EVENTI */
    .events{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: 10px;
    }

    .event{
      border-radius: 16px;
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,.10);
      padding: 12px;
    }

    .eventTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.80);
      font-weight: 800;
      font-size: 11px;
      margin-bottom: 8px;
    }
    .meta .smallDot{
      width:9px; height:9px; border-radius:99px;
      background: rgba(0,195,255,.7);
      box-shadow: 0 0 0 4px rgba(0,195,255,.14);
    }

    .teams{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 14px;
      font-weight: 900;
    }
    .teams .vs{ color: rgba(255,255,255,.45); font-weight: 900; }
    .crest{
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .crest img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display:block;
      background: rgba(0,0,0,0);
    }
    .crestFallback{
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,.85);
    }

    .slotPill{
      margin-left: 10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }

    .eventCount{
      color: rgba(255,255,255,.65);
      font-size: 11px;
      font-weight: 800;
      white-space:nowrap;
      margin-top: 2px;
    }

    .markets{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .mkt{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-height: 110px;
    }

    .mkt .lbl{
      font-weight: 900;
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.86);
      font-weight: 900;
      font-size: 11px;
      white-space:nowrap;
    }
    .tag.mid{ background: rgba(243,194,75,.10); border-color: rgba(243,194,75,.25); }
    .tag.low{ background: rgba(255,75,92,.10); border-color: rgba(255,75,92,.25); }

    .mHint{
      color: rgba(255,255,255,.68);
      font-size: 11px;
      line-height: 1.25;
      min-height: 30px;
    }

    .mActions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-top:auto;
    }
    .miniBtn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.90);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 12px;
      flex: 1;
      text-align:center;
      user-select:none;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.10); }
    .miniBtn.ghost{
      flex: .95;
      background: rgba(0,0,0,.18);
    }

    /* ANGOLO SPECIALE - PULITO */
    .special{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
    }
    .specialHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .specialHead b{
      font-size: 12px;
      letter-spacing:.2px;
    }
    .specialHead small{
      color: rgba(255,255,255,.65);
      font-weight: 800;
      font-size: 11px;
    }
    .specialGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .spItem{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px;
    }
    .spItem b{
      font-size: 12px;
      display:block;
      margin-bottom: 6px;
    }
    .spRow{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .spRow .line1{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      font-size: 12px;
      font-weight: 900;
    }
    .spRow .line2{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,.78);
      line-height: 1.25;
    }
    .spTags{
      margin-top: 7px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .spTag{
      display:inline-flex;
      align-items:center;
      padding: 5px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .spTag.mid{ background: rgba(243,194,75,.10); border-color: rgba(243,194,75,.25); }
    .spTag.low{ background: rgba(255,75,92,.10); border-color: rgba(255,75,92,.25); }

    /* SCHEDINA */
    .slipGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 11px;
      color: rgba(255,255,255,.70);
      font-weight: 800;
    }
    input, select{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.92);
      padding: 10px 10px;
      font-weight: 900;
      outline:none;
    }
    input::placeholder{ color: rgba(255,255,255,.40); }
    .slipList{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .pick{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 10px;
    }
    .pickTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 900;
      font-size: 12px;
    }
    .pickSub{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,.75);
      line-height:1.2;
    }
    .pickRow{
      margin-top: 10px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pickRow input{
      padding: 9px 10px;
      font-size: 12px;
      border-radius: 12px;
    }
    .rm{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,75,92,.10);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      padding: 9px 10px;
      user-select:none;
      white-space:nowrap;
    }

    .bigHint{
      margin-top: 10px;
      font-size: 11px;
      color: rgba(255,255,255,.70);
      line-height: 1.25;
    }

    /* MODAL */
    .modalBack{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
      backdrop-filter: blur(4px);
    }
    .modal{
      width: min(900px, 96vw);
      border-radius: 22px;
      background: rgba(20,22,36,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 22px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHead b{ font-size: 13px; }
    .close{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      font-weight: 900;
    }
    .modalBody{
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .panel{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 14px;
    }
    .panel h4{
      margin:0 0 10px 0;
      font-size: 12px;
      letter-spacing:.2px;
    }

    canvas{ width:100%; height:auto; display:block; }

    .resultBox{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 12px;
    }
    .resultBox b{ display:block; font-size: 12px; margin-bottom: 6px; }
    .resultBox p{ margin:0; color: rgba(255,255,255,.85); font-weight: 900; }

    /* QUIZ */
    .q{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .q b{ font-size: 12px; }
    .q .opt{
      cursor:pointer;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 10px;
      font-weight: 900;
      font-size: 12px;
      user-select:none;
    }
    .q .opt:hover{ background: rgba(255,255,255,.08); }

    /* Responsive */
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .specialGrid{ grid-template-columns: 1fr; }
      .modalBody{ grid-template-columns: 1fr; }
      .markets{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <div class="logo-badge"><span>v</span></div>
          <div class="logo-title">
            <b>Vincit√π ‚Ä¢ IA Portal</b>
            <small>Eventi reali ‚Ä¢ quote non mostrate: si inseriscono al banco</small>
          </div>
        </div>
      </div>

      <div class="statusRow">
        <span class="pill"><span class="dot"></span>Centro: <span id="centerName" style="opacity:.92;margin-left:4px">VINC001</span></span>
        <span class="pill">Agg: <span id="updatedAt" style="opacity:.92;margin-left:4px">‚Äî</span></span>
        <span class="pill">Fascia: <span id="slotName" style="opacity:.92;margin-left:4px">‚Äî</span></span>
        <button class="btn" id="btnWheel">üé° Ruota</button>
        <button class="btn" id="btnQuiz">üß† Quiz</button>
      </div>
    </div>

    <div class="grid">
      <!-- SINISTRA -->
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <button class="btn btn-accent" id="btnReload">‚ö° Nuovi eventi</button>
            <button class="btn" id="btnSlot">üïí Cambia fascia</button>
          </div>
          <div class="right">
            <span class="badge">Quote: verifica al banco</span>
            <span class="badge" id="countShown">Eventi mostrati: ‚Äî</span>
          </div>
        </div>

        <!-- ANGOLO SPECIALE (pulito) -->
        <div class="special" id="specialBox" style="display:none">
          <div class="specialHead">
            <b>üìå Angolo Speciale ‚Ä¢ Corner & Cartellini (top 2)</b>
            <small>Motivazione corta + 3 segnali</small>
          </div>
          <div class="specialGrid">
            <div class="spItem" id="spCorners">
              <b>üö© Corner Top 2</b>
              <span style="color:rgba(255,255,255,.75);font-size:11px;font-weight:800">Carico‚Ä¶</span>
            </div>
            <div class="spItem" id="spCards">
              <b>üü® Cartellini Top 2</b>
              <span style="color:rgba(255,255,255,.75);font-size:11px;font-weight:800">Carico‚Ä¶</span>
            </div>
          </div>
          <div class="subnote" style="margin-top:10px">
            Nota: sono indicazioni basate su segnali stimati (ritmo/equilibrio/fisicit√†). La quota reale va sempre verificata al banco.
          </div>
        </div>

        <div id="errBox" class="subnote" style="display:none; padding:10px 12px;border-radius:14px;border:1px solid rgba(255,75,92,.25);background:rgba(255,75,92,.08)"></div>

        <div class="events" id="events"></div>

        <div class="subnote" style="margin-top: 12px">
          Supporto informativo / intrattenimento. Nessuna garanzia. Gioca responsabilmente.
        </div>
      </div>

      <!-- DESTRA -->
      <div class="card">
        <h3>üßæ Schedina</h3>

        <div class="slipGrid">
          <div class="field">
            <label>Stake (‚Ç¨)</label>
            <input id="stake" type="number" min="0" step="0.5" value="5" />
          </div>

          <div class="field">
            <label>Tipo</label>
            <select id="type">
              <option value="multipla">Multipla (tutte)</option>
              <option value="singola">Singola</option>
            </select>
          </div>

          <div class="field">
            <label>Selezioni</label>
            <input id="selCount" value="0" disabled />
          </div>

          <div class="field">
            <label>Quota totale</label>
            <input id="totalOdd" value="‚Äî" disabled />
          </div>

          <div class="field">
            <label>Vincita pot.</label>
            <input id="potWin" value="‚Äî" disabled />
          </div>

          <div class="field">
            <label>Azioni</label>
            <button class="btn btn-accent btn-big" id="btnPrint">üñ®Ô∏è Stampa schedina</button>
          </div>
        </div>

        <div class="bigHint" id="slipHint">
          Nessuna selezione. Aggiungi una giocata a sinistra e poi inserisci la <b>quota reale</b> (dal banco) qui in schedina.
        </div>

        <div class="slipList" id="slipList"></div>
      </div>
    </div>
  </div>

  <!-- MODAL RUOTA -->
  <div class="modalBack" id="wheelBack">
    <div class="modal">
      <div class="modalHead">
        <b>üé° Ruota della Fortuna (consigli & missioni)</b>
        <div class="close" data-close="wheelBack">Chiudi ‚úï</div>
      </div>
      <div class="modalBody">
        <div class="panel">
          <h4>Gira la ruota</h4>
          <canvas id="wheelCanvas" width="520" height="520"></canvas>
          <button class="btn btn-accent btn-big" id="spinBtn" style="margin-top:12px">Gira la ruota</button>
          <div class="subnote" id="spinNote" style="margin-top:10px">
            1 giro al giorno su questo PC. Solo intrattenimento, gioco responsabile.
          </div>
        </div>
        <div class="panel">
          <h4>üéÅ Risultato</h4>
          <div class="resultBox">
            <b id="wheelTitle">In attesa‚Ä¶</b>
            <p id="wheelText">Gira la ruota per ricevere una missione semplice e utile.</p>
          </div>
          <div class="subnote" id="wheelMeta" style="margin-top:10px">
            Suggerimento: poche selezioni = pi√π controllo.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL QUIZ -->
  <div class="modalBack" id="quizBack">
    <div class="modal">
      <div class="modalHead">
        <b>üß† Quiz veloce (30 secondi)</b>
        <div class="close" data-close="quizBack">Chiudi ‚úï</div>
      </div>
      <div class="modalBody">
        <div class="panel">
          <h4>Domanda</h4>
          <div class="q" id="quizBox"></div>
        </div>
        <div class="panel">
          <h4>üéØ Feedback</h4>
          <div class="resultBox">
            <b id="quizTitle">Pronto?</b>
            <p id="quizText">Rispondi: l‚Äôobiettivo √® giocare con controllo.</p>
          </div>
          <div class="subnote" style="margin-top:10px">
            Mini-regola: se sei indeciso ‚Üí abbassa stake o salta.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =====================
    // Utils
    // =====================
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function euro(n){
      const x = Number(n);
      if(!isFinite(x)) return "‚Äî";
      return x.toLocaleString("it-IT", {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function toNum(v){
      const x = Number(String(v ?? "").replace(",", "."));
      return isFinite(x) ? x : NaN;
    }
    function todayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    // =====================
    // State
    // =====================
    const state = {
      data: null,
      slot: "sera",
      center: "VINC001",
      slip: [], // {key, match, market, tag, home, away, odd}
    };

    // =====================
    // Slot handling
    // =====================
    const slotLabel = {
      mattina: "Mattina",
      pomeriggio: "Pomeriggio",
      sera: "Sera",
    };

    function inferSlotFromNow(){
      const h = new Date().getHours();
      if(h >= 6 && h < 12) return "mattina";
      if(h >= 12 && h < 18) return "pomeriggio";
      return "sera";
    }

    // =====================
    // Fetch events.json
    // =====================
    async function loadEvents(){
      const errBox = document.getElementById("errBox");
      errBox.style.display = "none";
      errBox.textContent = "";

      try{
        const bust = `v=${Date.now()}`;
        const res = await fetch(`./events.json?${bust}`, {cache:"no-store"});
        if(!res.ok) throw new Error("Impossibile caricare events.json");
        const json = await res.json();
        state.data = json;

        document.getElementById("updatedAt").textContent = json.updated_at || "‚Äî";
        document.getElementById("centerName").textContent = state.center;

        const savedSlot = localStorage.getItem("vincitu_slot");
        state.slot = savedSlot || inferSlotFromNow();
        document.getElementById("slotName").textContent = slotLabel[state.slot] || state.slot;

        renderAll();
      }catch(e){
        errBox.style.display = "block";
        errBox.textContent = `Errore: events.json non caricato. Dettaglio: ${e.message || e}`;
        document.getElementById("events").innerHTML = "";
        document.getElementById("countShown").textContent = "Eventi mostrati: 0";
        document.getElementById("updatedAt").textContent = "‚Äî";
      }
    }

    // =====================
    // Crests
    // =====================
    function crestHtml(url, fallback){
      if(url){
        return `<span class="crest"><img src="${escapeHtml(url)}" alt="" onerror="this.parentNode.innerHTML='<span class=\\'crestFallback\\'>${escapeHtml(fallback)}</span>'"></span>`;
      }
      return `<span class="crest"><span class="crestFallback">${escapeHtml(fallback)}</span></span>`;
    }

    // =====================
    // Tags (Alta/Media/Bassa)
    // =====================
    function tagCls(tag){
      const t = (tag||"").toLowerCase();
      if(t.includes("alta")) return "";
      if(t.includes("media")) return "mid";
      return "low";
    }

    // =====================
    // Special (Corner / Cartellini) - pulito
    // =====================
    function spTag(label, cls=""){
      return `<span class="spTag ${cls}">${escapeHtml(label)}</span>`;
    }
    function lvlToCls(lvl){
      const t = (lvl||"").toLowerCase();
      if(t.includes("alta")) return "";
      if(t.includes("media")) return "mid";
      return "low";
    }

    function renderSpecial(allEvents){
      const specialBox = document.getElementById("specialBox");
      const cornersBox = document.getElementById("spCorners");
      const cardsBox = document.getElementById("spCards");

      const scored = (allEvents||[])
        .filter(e => e && e.context && e.context.signals)
        .map(e => ({
          e,
          corners: Number(e.context.corners || 0),
          cards: Number(e.context.cards || 0),
          sig: e.context.signals,
          rc: e.context.reason_corner || "Verifica al banco.",
          ry: e.context.reason_cards || "Verifica al banco."
        }));

      if(!scored.length){
        specialBox.style.display = "none";
        return;
      }

      specialBox.style.display = "block";

      const topCorners = scored.slice().sort((a,b)=>b.corners-a.corners).slice(0,2);
      const topCards   = scored.slice().sort((a,b)=>b.cards-a.cards).slice(0,2);

      function row(item, kind){
        const e = item.e;
        const s = item.sig;

        const ritmo = `Ritmo: ${s.ritmo}`;
        const eq = s.equilibrio;
        const fis = `Fisicit√†: ${s.fisicita}`;

        const clsR = lvlToCls(s.ritmo);
        const clsF = lvlToCls(s.fisicita);
        const reason = (kind==="c") ? item.rc : item.ry;

        return `
          <div class="spRow">
            <div class="line1">
              <span>${escapeHtml(e.home)} <span style="opacity:.5">-</span> ${escapeHtml(e.away)}</span>
              <span style="opacity:.72;font-size:11px">${escapeHtml(e.start || "")}</span>
            </div>
            <div class="spTags">
              ${spTag(ritmo, clsR)}
              ${spTag(eq, "mid")}
              ${spTag(fis, clsF)}
            </div>
            <div class="line2">${escapeHtml(reason)}</div>
          </div>
        `;
      }

      cornersBox.innerHTML =
        `<b>üö© Corner Top 2</b>` +
        (topCorners.length ? topCorners.map(x => row(x, "c")).join("") : `<span style="color:rgba(255,255,255,.75);font-size:11px;font-weight:800">Nessun dato.</span>`);

      cardsBox.innerHTML =
        `<b>üü® Cartellini Top 2</b>` +
        (topCards.length ? topCards.map(x => row(x, "y")).join("") : `<span style="color:rgba(255,255,255,.75);font-size:11px;font-weight:800">Nessun dato.</span>`);
    }

    // =====================
    // Render events list
    // =====================
    function renderAll(){
      const data = state.data;
      if(!data || !Array.isArray(data.events)){
        document.getElementById("events").innerHTML = "";
        document.getElementById("countShown").textContent = "Eventi mostrati: 0";
        return;
      }

      document.getElementById("slotName").textContent = slotLabel[state.slot] || state.slot;

      const evs = data.events.filter(e => (e.slot || "").toLowerCase() === state.slot);
      document.getElementById("countShown").textContent = `Eventi mostrati: ${evs.length} / ${data.counts ? data.counts.total : data.events.length}`;

      // Special uses ALL events (not only slot) to pick best corner/cards, but you can switch to evs if you prefer.
      renderSpecial(data.events);

      const box = document.getElementById("events");
      if(!evs.length){
        box.innerHTML = `
          <div class="subnote" style="margin-top:10px">
            Nessun evento in questa fascia. Prova a cambiare fascia.
          </div>
        `;
        return;
      }

      box.innerHTML = evs.map((e, idx) => {
        const comp = e.league || "Calcio";
        const start = e.start || "";
        const slot = slotLabel[e.slot] || e.slot || "";

        const home = e.home || "Home";
        const away = e.away || "Away";

        const homeCrest = crestHtml(e.home_crest, (e.home_short || home).slice(0,2).toUpperCase());
        const awayCrest = crestHtml(e.away_crest, (e.away_short || away).slice(0,2).toUpperCase());

        const markets = Array.isArray(e.markets) ? e.markets : [];
        const mHtml = markets.slice(0,3).map((m) => {
          const label = m.label || "Mercato";
          const tag = m.tag || "Media";
          const cls = tagCls(tag);

          const key = `${e.uniq || e.id}|${label}`;
          return `
            <div class="mkt">
              <div class="lbl">
                <span>${escapeHtml(label)}</span>
                <span class="tag ${cls}">${escapeHtml(tag)}</span>
              </div>
              <div class="mHint">Valutazione indicativa ‚Ä¢ quota reale al banco</div>
              <div class="mActions">
                <div class="miniBtn ghost" onclick="verifyAtDesk()">
                  Verifica al banco
                </div>
                <div class="miniBtn" onclick="addPick('${escapeHtml(key)}','${escapeHtml(home)}','${escapeHtml(away)}','${escapeHtml(comp)}','${escapeHtml(start)}','${escapeHtml(label)}','${escapeHtml(tag)}')">
                  + Aggiungi
                </div>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="event">
            <div class="eventTop">
              <div style="flex:1">
                <div class="meta">
                  <span class="smallDot"></span>
                  <span>${escapeHtml(comp)}</span>
                  <span style="opacity:.55">‚Ä¢</span>
                  <span>${escapeHtml(start)}</span>
                  <span class="slotPill">${escapeHtml(slot)}</span>
                </div>
                <div class="teams">
                  ${homeCrest}
                  <span>${escapeHtml(home)}</span>
                  <span class="vs">-</span>
                  <span>${escapeHtml(away)}</span>
                  ${awayCrest}
                </div>
              </div>
              <div class="eventCount">Evento ${idx+1}/${evs.length}</div>
            </div>

            <div class="markets">
              ${mHtml}
            </div>
          </div>
        `;
      }).join("");
    }

    // =====================
    // Slip
    // =====================
    function saveSlip(){
      localStorage.setItem("vincitu_slip", JSON.stringify(state.slip));
    }
    function loadSlip(){
      try{
        const s = JSON.parse(localStorage.getItem("vincitu_slip") || "[]");
        if(Array.isArray(s)) state.slip = s;
      }catch(_){}
    }

    function addPick(key, home, away, league, start, market, tag){
      // evita duplicati
      if(state.slip.some(p => p.key === key)) {
        flashHint("Gi√† aggiunta in schedina.");
        return;
      }
      state.slip.push({
        key,
        home, away, league, start,
        match: `${home} - ${away}`,
        market,
        tag,
        odd: "" // da inserire
      });
      saveSlip();
      renderSlip();
      flashHint("Aggiunta! Ora inserisci la quota reale in schedina.");
    }

    function removePick(key){
      state.slip = state.slip.filter(p => p.key !== key);
      saveSlip();
      renderSlip();
    }

    function updateOdd(key, val){
      const p = state.slip.find(x => x.key === key);
      if(!p) return;
      p.odd = val;
      saveSlip();
      renderSlipTotals();
    }

    function renderSlip(){
      const list = document.getElementById("slipList");
      document.getElementById("selCount").value = String(state.slip.length);

      if(!state.slip.length){
        list.innerHTML = "";
        document.getElementById("slipHint").innerHTML =
          `Nessuna selezione. Aggiungi una giocata a sinistra e poi inserisci la <b>quota reale</b> (dal banco) qui in schedina.`;
      }else{
        document.getElementById("slipHint").innerHTML =
          `‚úÖ Selezioni inserite: <b>${state.slip.length}</b>. Inserisci la quota reale per calcolare quota totale e vincita.`;
      }

      list.innerHTML = state.slip.map(p => {
        return `
          <div class="pick">
            <div class="pickTop">
              <span>${escapeHtml(p.match)}</span>
              <span class="tag ${tagCls(p.tag)}">${escapeHtml(p.tag)}</span>
            </div>
            <div class="pickSub">${escapeHtml(p.market)} ‚Ä¢ ${escapeHtml(p.league)} ‚Ä¢ ${escapeHtml(p.start)}</div>
            <div class="pickRow">
              <input
                type="text"
                inputmode="decimal"
                placeholder="Quota reale (es. 1.35)"
                value="${escapeHtml(p.odd)}"
                oninput="updateOdd('${escapeHtml(p.key)}', this.value)"
              />
              <div class="rm" onclick="removePick('${escapeHtml(p.key)}')">Rimuovi</div>
            </div>
          </div>
        `;
      }).join("");

      renderSlipTotals();
    }

    function renderSlipTotals(){
      const stake = toNum(document.getElementById("stake").value);
      const type = document.getElementById("type").value;

      // quota totale = prodotto delle quote inserite valide
      let odds = state.slip.map(p => toNum(p.odd)).filter(x => isFinite(x) && x > 1.0);

      let total = NaN;
      if(type === "singola"){
        // per singola: se 1 selezione prendi quella; se pi√π selezioni, mostra ‚Äî
        total = (odds.length === 1 && state.slip.length === 1) ? odds[0] : NaN;
      }else{
        total = odds.length === state.slip.length && state.slip.length > 0
          ? odds.reduce((a,b)=>a*b, 1)
          : NaN;
      }

      document.getElementById("totalOdd").value = isFinite(total) ? total.toFixed(2) : "‚Äî";
      const win = (isFinite(stake) && isFinite(total)) ? stake * total : NaN;
      document.getElementById("potWin").value = isFinite(win) ? euro(win) : "‚Äî";
    }

    function flashHint(msg){
      const el = document.getElementById("slipHint");
      const old = el.innerHTML;
      el.innerHTML = `${escapeHtml(msg)} <span style="opacity:.7">‚Ä¢ quota reale al banco</span>`;
      setTimeout(()=>{ el.innerHTML = old; }, 1600);
    }

    function verifyAtDesk(){
      flashHint("Verifica la quota al banco prima di inserire.");
    }

    // Print (semplice)
    function printSlip(){
      const stake = document.getElementById("stake").value;
      const type = document.getElementById("type").value;
      const totalOdd = document.getElementById("totalOdd").value;
      const potWin = document.getElementById("potWin").value;
      const dt = state.data?.updated_at || "";

      const rows = state.slip.map(p => `
        <tr>
          <td style="padding:8px;border-bottom:1px solid #ddd"><b>${escapeHtml(p.match)}</b><br><span style="color:#444">${escapeHtml(p.market)}</span></td>
          <td style="padding:8px;border-bottom:1px solid #ddd;text-align:right">${escapeHtml(p.odd || "‚Äî")}</td>
        </tr>
      `).join("");

      const html = `
        <html><head><meta charset="utf-8">
        <title>Schedina</title>
        <style>
          body{font-family:Arial,Helvetica,sans-serif;padding:18px}
          h2{margin:0 0 6px 0}
          .muted{color:#555;font-size:12px;margin-bottom:12px}
          table{width:100%;border-collapse:collapse;margin-top:10px}
          .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin-top:12px}
        </style>
        </head><body>
          <h2>Vincit√π ‚Ä¢ Schedina</h2>
          <div class="muted">Aggiornamento: ${escapeHtml(dt)} ‚Ä¢ Quote reali: verifica al banco</div>

          <div class="box">
            <b>Stake:</b> ${escapeHtml(stake)}‚Ç¨ &nbsp; | &nbsp;
            <b>Tipo:</b> ${escapeHtml(type)} &nbsp; | &nbsp;
            <b>Quota totale:</b> ${escapeHtml(totalOdd)} &nbsp; | &nbsp;
            <b>Vincita pot.:</b> ${escapeHtml(potWin)}
          </div>

          <table>
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:2px solid #000">Selezione</th>
                <th style="text-align:right;padding:8px;border-bottom:2px solid #000">Quota</th>
              </tr>
            </thead>
            <tbody>${rows || `<tr><td style="padding:8px">Nessuna selezione</td><td></td></tr>`}</tbody>
          </table>

          <div class="muted" style="margin-top:14px">
            Supporto informativo/intrattenimento. Nessuna garanzia. Gioca responsabilmente.
          </div>
        </body></html>
      `;

      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    // =====================
    // Wheel (Ruota)
    // =====================
    const wheelItems = [
      {t:"Missione: 1 sola selezione", d:"Oggi fai 1 singola con stake basso. Obiettivo: controllo e disciplina."},
      {t:"Missione: 2 selezioni max", d:"Fai massimo 2 selezioni. Se non trovi quota buona al banco, salta."},
      {t:"Regola d‚Äôoro", d:"Se sei indeciso ‚Üí non giocare. Il miglior bet √® quello evitato."},
      {t:"Focus: verifica quota", d:"Prima di inserire: controlla quota al banco e conferma che √® la stessa."},
      {t:"Gestione stake", d:"Oggi stake fisso (piccolo). Niente rincorse, niente aumento dopo perdita."},
      {t:"Pulizia schedina", d:"Togli una selezione: meno roba = pi√π controllo. Qualit√† > quantit√†."},
      {t:"Pausa intelligente", d:"Se hai gi√† giocato: stop. Torna domani con calma."},
      {t:"Mini-check", d:"Scrivi 1 motivo tecnico (ritmo/fisicit√†/equilibrio) prima di inserire."},
    ];

    let wheelAngle = 0;
    let spinning = false;

    function drawWheel(){
      const c = document.getElementById("wheelCanvas");
      const ctx = c.getContext("2d");
      const W = c.width, H = c.height;
      const cx = W/2, cy = H/2;
      const r = Math.min(W,H)*0.42;

      ctx.clearRect(0,0,W,H);

      // base circle
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(wheelAngle);

      const n = wheelItems.length;
      for(let i=0;i<n;i++){
        const a0 = (i/n) * Math.PI*2;
        const a1 = ((i+1)/n) * Math.PI*2;

        // colori a giro (semplici)
        const cols = ["#ff8a00","#35d07f","#f3c24b","#6a5cff","#00c3ff","#ff4b5c","#9b7b5d","#2f2f2f"];
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,r,a0,a1);
        ctx.closePath();
        ctx.fillStyle = cols[i % cols.length];
        ctx.globalAlpha = 0.85;
        ctx.fill();

        // testo
        ctx.save();
        ctx.globalAlpha = 1;
        ctx.rotate((a0+a1)/2);
        ctx.fillStyle = "rgba(0,0,0,.85)";
        ctx.font = "900 14px system-ui, -apple-system, Segoe UI";
        ctx.textAlign = "right";
        ctx.fillText("‚òÖ", r*0.82, 5);
        ctx.restore();
      }

      ctx.restore();

      // outline + pointer
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,.22)";
      ctx.lineWidth = 10;
      ctx.stroke();

      // pointer top
      ctx.beginPath();
      ctx.moveTo(cx, cy-r-18);
      ctx.lineTo(cx-14, cy-r+14);
      ctx.lineTo(cx+14, cy-r+14);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.fill();

      // center
      ctx.beginPath();
      ctx.arc(cx,cy,18,0,Math.PI*2);
      ctx.fillStyle = "rgba(20,22,36,.85)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,.30)";
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function canSpinToday(){
      const k = "vincitu_spin_" + todayKey();
      return localStorage.getItem(k) !== "done";
    }
    function setSpunToday(){
      const k = "vincitu_spin_" + todayKey();
      localStorage.setItem(k, "done");
    }

    function spin(){
      if(spinning) return;
      if(!canSpinToday()){
        document.getElementById("wheelTitle").textContent = "Hai gi√† girato oggi.";
        document.getElementById("wheelText").textContent = "Riprova domani su questo PC.";
        return;
      }

      spinning = true;
      const spinBtn = document.getElementById("spinBtn");
      spinBtn.textContent = "Gira...";
      spinBtn.disabled = true;

      const targetIndex = Math.floor(Math.random() * wheelItems.length);
      const n = wheelItems.length;
      const slice = (Math.PI*2) / n;

      // angolo per far uscire target sotto il puntatore (in alto)
      const base = (Math.PI*2) * 4; // giri extra
      const targetAngle = base + (Math.PI*2) - (targetIndex + 0.5) * slice;
      const start = wheelAngle;
      const end = targetAngle;

      const dur = 2600;
      const t0 = performance.now();

      function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

      function anim(t){
        const p = Math.min(1, (t - t0) / dur);
        wheelAngle = start + (end - start) * easeOutCubic(p);
        drawWheel();
        if(p < 1){
          requestAnimationFrame(anim);
        }else{
          spinning = false;
          setSpunToday();
          const it = wheelItems[targetIndex];
          document.getElementById("wheelTitle").textContent = it.t;
          document.getElementById("wheelText").textContent = it.d;
          document.getElementById("wheelMeta").textContent = "Fatto! Domani puoi girare di nuovo su questo PC.";
          spinBtn.textContent = "Giro fatto ‚úÖ";
          spinBtn.disabled = true;
        }
      }
      requestAnimationFrame(anim);
    }

    // =====================
    // Quiz
    // =====================
    const quiz = [
      {
        q: "Per ridurre il rischio, cosa √® meglio?",
        opts: [
          {t:"Aumentare le selezioni", ok:false, fb:"No: pi√π selezioni = pi√π variabili. Meglio poche."},
          {t:"Fare poche selezioni", ok:true, fb:"S√¨: poche selezioni = pi√π controllo."},
          {t:"Rincorrere dopo una perdita", ok:false, fb:"No: la rincorsa √® pericolosa. Stop e calma."},
        ]
      },
      {
        q: "Quando devi inserire la quota?",
        opts: [
          {t:"Solo dopo aver verificato al banco", ok:true, fb:"Giusto: la quota reale si verifica al banco."},
          {t:"Prima, basandoti su stime online", ok:false, fb:"No: qui usiamo stime. Quota reale solo al banco."},
          {t:"Non serve controllare", ok:false, fb:"No: controllare √® la base della disciplina."},
        ]
      },
      {
        q: "Se sei indeciso su una giocata‚Ä¶",
        opts: [
          {t:"La fai lo stesso", ok:false, fb:"No: indecisione = rischio. Meglio saltare."},
          {t:"Abbassi stake o salti", ok:true, fb:"S√¨: controllo prima di tutto."},
          {t:"Aumenti stake per recuperare", ok:false, fb:"No: mai aumentare per recuperare."},
        ]
      }
    ];
    let quizIdx = 0;

    function renderQuiz(){
      const box = document.getElementById("quizBox");
      const item = quiz[quizIdx];
      box.innerHTML = `
        <b>${escapeHtml(item.q)}</b>
        ${item.opts.map((o,i)=>`<div class="opt" onclick="answerQuiz(${i})">${escapeHtml(o.t)}</div>`).join("")}
        <div class="subnote" style="margin-top:10px">Domanda ${quizIdx+1}/${quiz.length}</div>
      `;
    }

    function answerQuiz(i){
      const item = quiz[quizIdx];
      const o = item.opts[i];
      document.getElementById("quizTitle").textContent = o.ok ? "‚úÖ Corretto" : "‚ö†Ô∏è Attenzione";
      document.getElementById("quizText").textContent = o.fb;

      quizIdx = (quizIdx + 1) % quiz.length;
      setTimeout(renderQuiz, 650);
    }

    // =====================
    // Modal open/close
    // =====================
    function openModal(id){
      document.getElementById(id).style.display = "flex";
      if(id === "wheelBack"){
        // reset UI spin button
        drawWheel();
        const btn = document.getElementById("spinBtn");
        if(canSpinToday()){
          btn.textContent = "Gira la ruota";
          btn.disabled = false;
          document.getElementById("wheelTitle").textContent = "In attesa‚Ä¶";
          document.getElementById("wheelText").textContent = "Gira la ruota per ricevere una missione semplice e utile.";
          document.getElementById("wheelMeta").textContent = "Suggerimento: poche selezioni = pi√π controllo.";
        }else{
          btn.textContent = "Giro gi√† fatto ‚úÖ";
          btn.disabled = true;
          document.getElementById("wheelTitle").textContent = "Hai gi√† girato oggi.";
          document.getElementById("wheelText").textContent = "Riprova domani su questo PC.";
          document.getElementById("wheelMeta").textContent = "Tip: se oggi hai giocato, stop e calma.";
        }
      }
      if(id === "quizBack"){
        renderQuiz();
        document.getElementById("quizTitle").textContent = "Pronto?";
        document.getElementById("quizText").textContent = "Rispondi: l‚Äôobiettivo √® giocare con controllo.";
      }
    }
    function closeModal(id){
      document.getElementById(id).style.display = "none";
    }

    // =====================
    // Events
    // =====================
    document.getElementById("btnReload").addEventListener("click", loadEvents);
    document.getElementById("btnSlot").addEventListener("click", () => {
      const order = ["mattina","pomeriggio","sera"];
      const idx = order.indexOf(state.slot);
      state.slot = order[(idx+1) % order.length];
      localStorage.setItem("vincitu_slot", state.slot);
      renderAll();
    });

    document.getElementById("stake").addEventListener("input", renderSlipTotals);
    document.getElementById("type").addEventListener("change", renderSlipTotals);
    document.getElementById("btnPrint").addEventListener("click", printSlip);

    // Modals
    document.getElementById("btnWheel").addEventListener("click", () => openModal("wheelBack"));
    document.getElementById("btnQuiz").addEventListener("click", () => openModal("quizBack"));
    document.querySelectorAll(".close").forEach(x => {
      x.addEventListener("click", () => closeModal(x.getAttribute("data-close")));
    });
    document.getElementById("wheelBack").addEventListener("click", (e) => {
      if(e.target.id === "wheelBack") closeModal("wheelBack");
    });
    document.getElementById("quizBack").addEventListener("click", (e) => {
      if(e.target.id === "quizBack") closeModal("quizBack");
    });

    document.getElementById("spinBtn").addEventListener("click", spin);

    // =====================
    // Boot
    // =====================
    window.addPick = addPick;
    window.removePick = removePick;
    window.updateOdd = updateOdd;
    window.verifyAtDesk = verifyAtDesk;
    window.answerQuiz = answerQuiz;

    loadSlip();
    renderSlip();
    loadEvents();

    // Draw wheel once
    drawWheel();
  </script>
</body>
</html>
